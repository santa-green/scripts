--ƒобавление новых наборов
--1 утром до открыти€ магазинов переименовать пол€ Notes и UAProdName с добавлением &A N
--на кода наборов добавить штрихкода
BEGIN TRAN

	SELECT * FROM ElitR.dbo.r_Prods where ProdID in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)

	UPDATE ElitR.dbo.r_Prods 
	SET Notes = Notes + '&A N', UAProdName = UAProdName + '&A N'
	WHERE ProdID in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)

	SELECT * FROM ElitR.dbo.r_Prods where ProdID in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)

ROLLBACK TRAN

--2 ƒистр. —правочник товаров. «авести новые коды наборов.  ол-во кодов = кол-ву кодов по јрде из внешних кодов
BEGIN TRAN

	INSERT ElitDistr.dbo.r_Prods_
		SELECT ROW_NUMBER()OVER(ORDER BY ProdID) + (SELECT MAX(ChID) FROM ElitDistr.dbo.r_Prods_) ChID, 
		ROW_NUMBER()OVER(ORDER BY ProdID) + (SELECT MAX(ProdID) FROM ElitDistr.dbo.r_Prods where ProdName like '%&A N%') ProdID,
		ProdName + '&A N' ProdName, 'наб≥р' UM, Country, Notes + '&A N' Notes, PCatID, PGrID, Article1, Article2, Article3, Weight, Age, TaxPercent, PriceWithTax, Note1, Note2, Note3, MinPriceMC, MaxPriceMC, MinRem, CstDty, CstPrc, CstExc, StdExtraR, StdExtraE, MaxExtra, MinExtra, UseAlts, UseCrts, PGrID1, PGrID2, PGrID3, PGrAID, PBGrID, LExpSet, EExpSet, InRems, IsDecQty, File1, File2, File3, AutoSet, Extra1, Extra2, Extra3, Extra4, Extra5, Norma1, Norma2, Norma3, Norma4, Norma5, RecMinPriceCC, RecMaxPriceCC, RecStdPriceCC, RecRemQty, 0 InStopList, PrepareTime, AmortID, WeightGr, WeightGrWP, PGrID4, PGrID5, DistrID, ImpID, FEAprodID, ScaleGrID, ScaleStandard, ScaleConditions, ScaleComponents, ExcCostCC, CstDtyNotes, CstExcNotes, BoxVolume, SalesChannelID, IndRetPriceCC, IndWSPriceCC, SupID
		FROM ElitDistr.dbo.r_Prods 
		where ProdID  in (SELECT ProdID FROM Elit.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
		and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297))--новые наборы в ElitR

	SELECT * FROM ElitDistr.dbo.r_Prods where ProdName like '%&A N%' ORDER BY ProdID

ROLLBACK TRAN

--3 добавить новые штрихкоды
BEGIN TRAN

INSERT r_ProdMQ_
SELECT ProdID, UM, 1 Qty, 0 Weight, null Notes, (cast(ProdID as varchar) + '_' + cast(UM as varchar)) BarCode, (cast(ProdID as varchar) + '_' + cast(UM as varchar)) ProdBarCode, 0 PLID 
FROM ElitDistr.dbo.r_Prods p where ProdID in (634160,634166,634158,634159,634161,634162,634165,634175,634163,634164,634170,634171,634174,634178,634179,634173,634167,634176,634168,634169,634172,634177)
SELECT * FROM r_ProdMQ WHERE ProdID in (634160,634166,634158,634159,634161,634162,634165,634175,634163,634164,634170,634171,634174,634178,634179,634173,634167,634176,634168,634169,634172,634177)

ROLLBACK TRAN

--4 добавить нулевые партии
BEGIN TRAN

	--добавить отсутствующие партии в t_PInP из elit дл€ возвратов
	INSERT ElitDistr.dbo.t_PInP (ProdID,PPID,PPDesc,PriceMC_In,PriceMC,Priority,ProdDate,CurrID,CompID,Article,CostAC,PPWeight,File1,File2,File3,PriceCC_In,CostCC,PPDelay,ProdPPDate,DLSDate,IsCommission,CostMC,PriceAC_In,IsCert,FEAProdID,ProdBarCode,PPHumidity,PPImpurity,CustDocNum,CustDocDate)
		SELECT rp.ProdID,p.PPID,PPDesc,PriceMC_In,PriceMC,Priority,ProdDate,CurrID,CompID,Article,CostAC,PPWeight,p.File1,p.File2,p.File3,PriceCC_In,CostCC,PPDelay,ProdPPDate,DLSDate,IsCommission,CostMC,PriceAC_In,IsCert,CstProdCode,ProdBarCode,PPHumidity,PPImpurity,CustDocNum,CstDocDate 
		FROM [Elit].dbo.t_PInP p
		join ElitDistr.dbo.r_Prods rp on 30767 = p.ProdID and p.PPID = 0 
		WHERE rp.ProdID in (634160,634166,634158,634159,634161,634162,634165,634175,634163,634164,634170,634171,634174,634178,634179,634173,634167,634176,634168,634169,634172,634177)

ROLLBACK TRAN

--5 добавить наборы в прайслист
BEGIN TRAN

INSERT ElitDistr.dbo.r_ProdMP
SELECT ProdID_ElitDistr_Nabor ProdID, 66 PLID, PriceMC PriceMC, null Notes, 1 CurrID FROM (
	SELECT ec.ExtProdID ProdID_ElitR, ec.ProdID ProdID_Elit, (SELECT PriceMC FROM Elit.dbo.r_ProdMP mp WHERE mp.ProdID = ec.ProdID and mp.PLID = 66) PriceMC,
	(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor
	FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
	and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
)s1
SELECT * FROM ElitDistr.dbo.r_ProdMP WHERE ProdID in (634160,634166,634158,634159,634161,634162,634165,634175,634163,634164,634170,634171,634174,634178,634179,634173,634167,634176,634168,634169,634172,634177)
ROLLBACK TRAN

--6 обновить коды уктвед в справочнике товаров
BEGIN TRAN

--обновить коды уктвед в справочнике товаров
;DISABLE TRIGGER ALL ON r_Prods_;  
update edp
set edp.FEAprodID = s1.CstProdCode
FROM ElitDistr.dbo.r_Prods_ edp
join (
SELECT ec.ProdID ProdID_Elit,
(SELECT top 1 p.CstProdCode FROM Elit.dbo.t_PInP p where p.ProdID = ec.ProdID and LEN(p.CstProdCode)>2 ORDER BY PPID ) CstProdCode ,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
) s1 on s1.ProdID_ElitDistr_Nabor = edp.ProdID;
ENABLE  TRIGGER ALL ON r_Prods_;

SELECT edp.FEAprodID,s1.CstProdCode,* FROM ElitDistr.dbo.r_Prods edp
join (
SELECT ec.ProdID ProdID_Elit,
(SELECT top 1 p.CstProdCode FROM Elit.dbo.t_PInP p where p.ProdID = ec.ProdID and LEN(p.CstProdCode)>2 ORDER BY PPID ) CstProdCode ,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
) s1 on s1.ProdID_ElitDistr_Nabor = edp.ProdID
 

ROLLBACK TRAN

-- 7 обновить коды уктвед  в парти€х
BEGIN TRAN


--обновить коды уктвед  в парти€х
update edp
set edp.FEAprodID = s1.CstProdCode
FROM ElitDistr.dbo.t_PInP edp
join (
SELECT ec.ProdID ProdID_Elit,
(SELECT top 1 p.CstProdCode FROM Elit.dbo.t_PInP p where p.ProdID = ec.ProdID and LEN(p.CstProdCode)>2 ORDER BY PPID ) CstProdCode ,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
) s1 on s1.ProdID_ElitDistr_Nabor = edp.ProdID;

SELECT edp.FEAprodID,s1.CstProdCode,* FROM ElitDistr.dbo.t_PInP edp
join (
SELECT ec.ProdID ProdID_Elit,
(SELECT top 1 p.CstProdCode FROM Elit.dbo.t_PInP p where p.ProdID = ec.ProdID and LEN(p.CstProdCode)>2 ORDER BY PPID ) CstProdCode ,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
) s1 on s1.ProdID_ElitDistr_Nabor = edp.ProdID

ROLLBACK TRAN




--справочник новых наборов с 6,07,2018
SELECT ec.ExtProdID ProdID_ElitR, ec.ProdID ProdID_Elit,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor,
(SELECT p2.UAProdName FROM ElitR.dbo.r_Prods p2 where p2.ProdID = ec.ExtProdID ) prodname_ElitR ,
(SELECT p.Notes FROM Elit.dbo.r_Prods p where p.ProdID = ec.ProdID ) prodname_Elit ,
(SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID ) ProdName_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
ORDER BY 1
--справочник наборов до 6,07,2018
SELECT ec.ExtProdID ProdID_ElitR, ec.ProdID ProdID_Elit,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor,
(SELECT p3.ProdID FROM ElitDistr.dbo.r_Prods p3 where p3.ProdName = (SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID )  ) ProdID_ElitDistr_Nabor2,
(SELECT p2.UAProdName FROM ElitR.dbo.r_Prods p2 where p2.ProdID = ec.ExtProdID ) prodname_ElitR ,
(SELECT p.Notes FROM Elit.dbo.r_Prods p where p.ProdID = ec.ProdID ) prodname_Elit ,
(SELECT p4.ProdName + '&A N' FROM ElitDistr.dbo.r_Prods p4 where p4.ProdID = ec.ProdID ) ProdName_ElitDistr_Nabor
FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID in (10797)
and cast(ExtProdID as bigint) in (600072,600132,600133,600134,600135,600136,600159,600160,600168,600267,600267,600299,600712,600712,600721,600721,600731,600732,600742,600743,600744,600745,600757,600757,600758,600758,600758,600760,600760,600773,600773,600816,600816,600816,600832,600839,600839,600840,600840,600882,600883,600883,600884,600884,600884,600884,600884,600885,600885,600887,600891,600891,600892,600895,600895,600987,601070,601070,601078,601085,601085,601085,601085,601086,601095,601095,601105,601106,601111,601115,601116,601626,601773,601784,602042,602290,602505,602507,602563,602563,602563,602564,602564,602669,602669,602755,602755,603053,603053,603053,603928,603936,603975,604603,604851,604979,604980,604980,800084,800084,800164,800164,800164,800165,800165,800594,800594,800594,800621,800779,801098,801099,801301,801451,801562,801563,801564,801565,801642,801720,801721,801935,801949,801952,802174,802185,802375,802376,802394,802399,802402,802408,802412,802412,802424,802424,802471,802484,802485,802486,802489,802489,802490,802490,802511,802650,802651,802656,802657,802705,802705,802751,802751,802752,802982,803013,803013,803016)
--and ec.ProdID in (31827,33681,33697,33736)
--and ec.ExtProdID in (601784)
ORDER BY 3

/*
--SELECT * FROM ElitR.dbo.r_Prods where ProdID in (600712)
--SELECT * FROM ElitR.dbo.r_Prods where ProdID in (802440)
--SELECT * FROM Elit.dbo.r_Prods where ProdID in (4668)
--SELECT * FROM Elit.dbo.r_Prods where ProdID in (31827,33681,33697,33736)

SELECT distinct ProdID FROM ElitR.dbo.r_Prods where UAProdName like '%&A N%'
SELECT * FROM ElitR.dbo.r_Prods where UAProdName like '%&A N%' ORDER BY 2
SELECT * FROM ElitR.dbo.r_Prods 
where 
ProdID in (600072,600132,600133,600134,600135,600136,600159,600160,600168,600267,600267,600299,600712,600712,600721,600721,600731,600732,600742,600743,600744,600745,600757,600757,600758,600758,600758,600760,600760,600773,600773,600816,600816,600816,600832,600839,600839,600840,600840,600882,600883,600883,600884,600884,600884,600884,600884,600885,600885,600887,600891,600891,600892,600895,600895,600987,601070,601070,601078,601085,601085,601085,601085,601086,601095,601095,601105,601106,601111,601115,601116,601626,601773,601784,602042,602290,602505,602507,602563,602563,602563,602564,602564,602669,602669,602755,602755,603053,603053,603053,603928,603936,603975,604603,604851,604979,604980,604980,800084,800084,800164,800164,800164,800165,800165,800594,800594,800594,800621,800779,801098,801099,801301,801451,801562,801563,801564,801565,801642,801720,801721,801935,801949,801952,802174,802185,802375,802376,802394,802399,802402,802408,802412,802412,802424,802424,802471,802484,802485,802486,802489,802489,802490,802490,802511,802650,802651,802656,802657,802705,802705,802751,802751,802752,802982,803013,803013,803016) 
and not Notes like '%&A N%'

--&A N 600072,600132,600133,600134,600135,600136,600159,600160,600168,600267,600299,600712,600721,600731,600732,600742,600743,600744,600745,600757,600758,600760,600773,600816,600832,600839,600840,600882,600883,600884,600885,600887,600891,600892,600895,600987,601070,601078,601085,601086,601095,601105,601106,601111,601115,601116,601626,601773,601784,602042,602290,602505,602507,602563,602564,602669,602755,603053,603928,603936,603975,604603,604851,604979,604980,800084,800164,800165,800594,800621,800779,801098,801099,801301,801451,801562,801563,801564,801565,801642,801720,801721,801935,801949,801952,802174,802185,802375,802376,802394,802399,802402,802408,802412,802424,802471,802484,802485,802486,802489,802490,802511,802650,802651,802656,802657,802705,802751,802752,802982,803013,803016
--     600072,600132,600133,600134,600135,600136,600159,600160,600168,600267,600267,600299,600712,600712,600721,600721,600731,600732,600742,600743,600744,600745,600757,600757,600758,600758,600758,600760,600760,600773,600773,600816,600816,600816,600832,600839,600839,600840,600840,600882,600883,600883,600884,600884,600884,600884,600884,600885,600885,600887,600891,600891,600892,600895,600895,600987,601070,601070,601078,601085,601085,601085,601085,601086,601095,601095,601105,601106,601111,601115,601116,601626,601773,601784,602042,602290,602505,602507,602563,602563,602563,602564,602564,602669,602669,602755,602755,603053,603053,603053,603928,603936,603975,604603,604851,604979,604980,604980,800084,800084,800164,800164,800164,800165,800165,800594,800594,800594,800621,800779,801098,801099,801301,801451,801562,801563,801564,801565,801642,801720,801721,801935,801949,801952,802174,802185,802375,802376,802394,802399,802402,802408,802412,802412,802424,802424,802471,802484,802485,802486,802489,802489,802490,802490,802511,802650,802651,802656,802657,802705,802705,802751,802751,802752,802982,803013,803013,803016

SELECT distinct ec.ProdID, ec.ExtProdID, ec.CompID FROM Elit.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 
and cast(ExtProdID as bigint) in (SELECT distinct ProdID FROM ElitR.dbo.r_Prods where UAProdName like '%&A N%')
--and CompID = 10797
ORDER BY 2

*/




--все коды товаров ElitR которые продаютс€ как наборы
SELECT distinct ProdID, UAProdName FROM ElitR.dbo.r_Prods where UAProdName like '%&A N%'
--все коды товаров Elit которые продаютс€ как наборы в ElitR
SELECT distinct ec.ProdID, ec.ExtProdID/*, ec.CompID*/ FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 
and cast(ExtProdID as bigint) in (SELECT distinct ProdID FROM ElitR.dbo.r_Prods where UAProdName like '%&A N%')
and CompID = 10797
ORDER BY 2

--новые коды товаров Elit которые продаютс€ как наборы в ElitR
SELECT ProdID FROM ElitDistr.dbo.r_ProdEC ec where ISNUMERIC(ExtProdID) = 1 and CompID = 10797 
and cast(ExtProdID as bigint) in (802440,800780,803003,802443,600894,802396,800353,802466,600736,600297)
ORDER BY 1
--28245,28268,28572,30734,31282,31312,31746,32346,32363,32366,32379,32388,32403,32463,32560,32618,33015,33023,33039,33106,33434,34152



--все коды товаров ElitDistr которые продаютс€ как наборы
SELECT * FROM ElitDistr.dbo.r_Prods where ProdName like '%&A N%' ORDER BY ProdID
SELECT * FROM ElitDistr.dbo.r_Prods where ProdID in (634158,634159,634160,634161,634162,634163,634164,634165,634166,634167,634168,634169,634170,634171,634172,634173,634174,634175,634176,634177,634178,634179) ORDER BY ProdID
-- не найденые наборы
SELECT * FROM ElitDistr.dbo.r_Prods where ProdName like '%&A N%' 
and ProdID not in (634000,634001,634002,634003,634004,634005,634006,634007,634008,634009,634010,634011,634012,634013,634014,634016,634017,634018,634019,634020,634021,634023,634024,634025,634026,634027,634028,634029,634030,634031,634032,634034,634035,634036,634038,634039,634040,634041,634042,634043,634046,634047,634048,634049,634050,634051,634053,634054,634056,634057,634058,634059,634060,634061,634062,634064,634065,634066,634067,634068,634069,634070,634071,634072,634073,634074,634076,634077,634078,634080,634083,634085,634086,634087,634088,634089,634090,634091,634092,634093,634094,634095,634096,634097,634100,634101,634102,634104,634105,634106,634107,634108,634109,634110,634111,634112,634113,634114,634115,634116,634117,634118,634119,634120,634121,634122,634123,634124,634125,634128,634129,634130,634131,634132,634134,634135,634136,634137,634138,634139,634140,634141,634142,634143,634144,634145,634146,634147,634148,634149,634150,634152,634153,634154,634155,634156,634157)
ORDER BY ProdID

SELECT * FROM ElitDistr.dbo.r_Prods where ProdName like '%¬ино F. La Linda. “оронтес 2016 белое 0,75*12%' ORDER BY ProdID
32784	¬ино F. La Linda. “оронтес 2016 белое 0,75*12
634015	¬ино F. La Linda. “оронтес 2016 белое 0,75*12&A N

SELECT * FROM ElitDistr.dbo.r_Prods where ProdID in (28245,28268,28572,30734,31282,31312,31746,32346,32363,32366,32379,32388,32403,32463,32560,32618,33015,33023,33039,33106,33434,34152)


SELECT * FROM ElitDistr.dbo.r_Prods where ProdID = 634000 
SELECT InStopList FROM ElitDistr.dbo.r_Prods_ where ProdID = 634000 
