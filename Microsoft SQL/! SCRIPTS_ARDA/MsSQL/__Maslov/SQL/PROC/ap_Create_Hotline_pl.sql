ALTER PROCEDURE [dbo].[ap_Create_Hotline_pl] @api_l VARCHAR(500) = '', @key VARCHAR(500) = '', @admin_adress VARCHAR(500) = '', @Test INT = 0
AS
BEGIN
/*
Формируем основу xml, который будет хранить прайс-лист для Hotline.
*/

/*
--@Test = 0 - Рабочий режим.
--@Test = 1 - Рабочий режим для админа.
--@Test = 2 - Тестовый режим без изменения таблиц.

EXEC ap_Create_Hotline_pl @api_l = '4a31bd883165bfd2bb8932c6287e7b9c', @key = '6bab3199775c589f2922cd5bdb48a10b', @admin_adress = 'vintagemarket-dev.myshopify.com', @Test = 1
*/

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/*CHANGELOG*/
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--Ниже идет предварительная настройка временных таблиц и объявление переменных.
SET TEXTSIZE 2147483647;
SET NOCOUNT ON

DECLARE @temp TABLE (res VARCHAR(MAX))

DECLARE @URI VARCHAR(3000)
	   ,@methodName VARCHAR(50)
	   ,@proxy VARCHAR(50) 
	   ,@proxySettings VARCHAR(50)
	   ,@objectID INT
	   ,@hResult INT
	   ,@source VARCHAR(255)
	   ,@desc VARCHAR(255)
	   ,@login_proxy VARCHAR(200) = 'CONST\vintageshopify'
	   ,@for_proxy VARCHAR(100) = (SELECT CONVERT(VARCHAR(100), DecryptByPassPhrase(ORIGINAL_LOGIN(), 0x010000008031F55516F8B14295198F75BC4E74AC92D4D00FCE81357226B84D9109E90731 )))
	   ,@site VARCHAR(3000) = 'https://' + @api_l + ':' + @key + '@' + @admin_adress

--Плачу на техно.
IF @Test != 0
BEGIN
	SET @for_proxy = (SELECT CONVERT(VARCHAR(100), DecryptByPassPhrase(ORIGINAL_LOGIN(), 0x010000006F172BCB88E67FBA563BEF67FB02F5319B61CD88F32C063328550C861DE6E0CD)))
END;

DECLARE @statusText VARCHAR(1000), @status VARCHAR(1000)

DECLARE @f INT = 0
DECLARE @link VARCHAR(8000)
WHILE(@f != 2)
BEGIN
--Формируем особый URL-адрес, который достанет первые товары. 
SELECT @URI = CASE WHEN @f = 0
					THEN @site
					     --Достаем определенные поля товаров.
					     + '/admin/api/2020-01/products.xml?limit=250;fields=id,variants,handle,image'
					ELSE @URI END
	  ,@methodName = 'GET'
	  ,@proxy = '2' 
	  ,@proxySettings = '10.1.0.16:8080'

	IF 1 = 1
	BEGIN
			IF 	@methodName = ''
			BEGIN
				SELECT FailPoINT = 'Method Name must be set'
				RETURN
			END 

			EXEC 	@hResult = sp_OACreate 'WinHttp.WinHttpRequest.5.1', @objectID OUT

			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
						source = @source, 
						description = @desc,
						FailPoINT = 'Create failed',
						MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			-- open the destination URI with Specified method
			EXEC @hResult = sp_OAMethod @objectID, 'open', null, @methodName, @URI, 'false'
			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'Open failed',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			-- Особый хэдер URL-запроса для Shopify, для того, чтобы обойти аутентификацию.
			EXEC @hResult = sp_OAMethod @objectID, 'setRequestHeader', null, 'X-Shopify-Access-Token', @key
			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'SetRequestHeader failed: Content-Type',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			/*Устанавливаем логин и пароль для прокси-сервера.*/
			EXEC @hResult = sp_OAMethod @objectID, 'setCredentials', null, @login_proxy, @for_proxy, 1
			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'setProxyCredentials failed',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			--Делаем так, чтобы URL-запрос пошел через прокси-сервер.
			EXEC @hResult = sp_OAMethod @objectID, 'setProxy', NULL,  @proxy, @proxySettings
			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'SetProxy'
				GOTO global_destroy
				RETURN
			END
		
			--Отправляем запрос.
			EXEC @hResult = sp_OAMethod @objectID, 'send', null
			IF 	@hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'Send failed',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			-- Get status text
			EXEC sp_OAGetProperty @objectID, 'StatusText', @statusText out 
			EXEC sp_OAGetProperty @objectID, 'Status', @status out 

			--Достаем из заголовка ссылки.
			EXEC @hResult = sp_OAMethod @objectID, 'getResponseHeader', @link OUT, 'Link'
			IF 	@hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'HEADER',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END

			-- Get response text
			INSERT INTO @temp
				 EXEC sp_OAGetProperty @objectID, 'responseText'

			IF @hResult <> 0
			BEGIN
				EXEC sp_OAGetErrorInfo @objectID, @source OUT, @desc OUT 
				SELECT 	hResult = convert(varbinary(4), @hResult), 
					source = @source, 
					description = @desc,
					FailPoINT = 'ResponseText failed',
					MedthodName = @methodName
				GOTO global_destroy
				RETURN
			END
	END;

	--Если нет ссылки на страницу "дальше".
	IF (SELECT CHARINDEX('rel="next"', @link)) = 0
	BEGIN
		SET @f = 2
	END;
	ELSE
	BEGIN
		SELECT @f = 1
			   --Если ссылка на страницу "дальше" есть, то достаем ее.
			  ,@URI = SUBSTRING(PString,CHARINDEX('https://', PString), CHARINDEX('>; rel="next"', PString) - CHARINDEX('https://', PString)) FROM af_SplitString(@link, ',') WHERE PString LIKE '%rel="next"%'
	END;
END;

--Удаляем мусор.
UPDATE @temp SET res = REPLACE(res, '<?xml version="1.0" encoding="UTF-8"?>', '');

--Дальше обрабатываем полученный ответ.
DECLARE @prods TABLE (ProdInfo XML)

INSERT INTO @prods
SELECT CAST(res AS XML) FROM @temp
--SELECT * FROM @prods

IF @Test = 2
BEGIN
	
	SELECT *
	FROM (
	SELECT prods.pr.value('(id)[1]', 'bigint') AS 'ShopifyID'
		  ,CASE WHEN CAST (pr.query('data(variants/variant/sku)') AS VARCHAR(10)) LIKE '%[^0-9]%' 
				THEN 0
				ELSE CAST( (CAST (pr.query('data(variants/variant/sku)') AS VARCHAR(10)) ) AS INT) END 'ProdID'
		  ,'https://vintagemarket.com.ua/products/' + prods.pr.value('(handle)[1]', 'varchar(250)') AS 'ShopifyURI'
		  ,prods.pr.value('(image/src)[1]', 'varchar(4000)') AS 'ShopifyImageURI'
	FROM @prods p CROSS APPLY p.ProdInfo.nodes('products/product') prods(pr)
	) AS q1
	WHERE q1.ShopifyImageURI IS NULL AND q1.ProdID != 0

	GOTO global_destroy	

END;

DECLARE @TableProds table(ProdID int NULL, PricePromo numeric(21,9) NULL, Price numeric(21,9) NULL) 
INSERT INTO @TableProds 
	--список товаров для продажи в Алло
	SELECT ProdID,АкционнаяЦена,Цена FROM (
	SELECT ProdID,UAProdName
	,max(case when TypeStock = 'Днепр' then Qty else 0 end) 'Д'
	,max(case when TypeStock = 'Киев' then Qty else 0 end) 'К'
	,max(case when TypeStock = 'Харьков' then Qty else 0 end) 'Х'
	,max(PromoPriceCC) АкционнаяЦена
	,max(PriceCC) Цена
	FROM
	(
		SELECT m.ProdID,m.Qty,'Днепр' TypeStock,epa.PromoPriceCC ,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Dnepr_Shopify] m--[av_VC_ExportRemsR_Dnepr] m
		JOIN r_Prods rp WITH(NOLOCK) ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 1
		LEFT JOIN [av_VC_ExportPromos] epa ON ep.ProdID = epa.ProdID AND epa.RegionID = 1 and dbo.zf_GetDate(GETDATE()) BETWEEN epa.BDate and epa.EDate
			UNION ALL
		SELECT m.ProdID,m.Qty,'Киев' TypeStock,epa.PromoPriceCC ,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Kiev_Shopify] m--[av_VC_ExportRemsR_Harkov] m
		JOIN r_Prods rp WITH(NOLOCK) ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 2
		LEFT JOIN [av_VC_ExportPromos] epa ON ep.ProdID = epa.ProdID AND epa.RegionID = 5 and dbo.zf_GetDate(GETDATE()) BETWEEN epa.BDate and epa.EDate
			UNION ALL
		SELECT m.ProdID,m.Qty,'Харьков' TypeStock,epa.PromoPriceCC ,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Harkov_Shopify] m--[av_VC_ExportRemsR_Harkov] m
		JOIN r_Prods rp WITH(NOLOCK) ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 5
		LEFT JOIN [av_VC_ExportPromos] epa ON ep.ProdID = epa.ProdID AND epa.RegionID = 5 and dbo.zf_GetDate(GETDATE()) BETWEEN epa.BDate and epa.EDate
	) s1
	group by ProdID,UAProdName
	Having ProdID in 
	(
	--600001,600003,600006,600008,600046,600048,600049,600051,600062,600070,600093,600096,600098,600122,600123,600125,600172,600173,600186,600205,600206,600207,600280,600282,600283,600287,600288,600289,600290,600291,600293,600294,600300,600302,600307,600308,600336,600339,600342,600345,600347,600349,600356,600393,600395,600396,600404,600405,600406,600793,600898,601045,601138,601209,601214,601731,602105,602106,602107,602109,602110,602111,602112,602113,602114,602116,602118,602119,602120,602122,602124,602125,602126,602128,602135,602136,602137,602144,602293,602294,602295,602296,602304,602305,602311,602319,602320,602321,602322,602324,602325,602328,602329,602330,602332,602353,602360,602362,602364,602373,602374,602375,602376,602377,602380,602381,602384,602385,602386,602387,602400,602406,602407,602409,602410,602411,602412,602413,602414,602415,602416,602417,602419,602421,602425,602426,602427,602428,602429,602431,602432,602433,602434,602435,602436,602437,602438,602439,602440,602441,602442,602495,602937,602938,603003,603014,603059,603061,603142,603221,603244,603247,603248,603400,603541,603561,603562,603564,603687,603937,603984,604283,604358,604514,604515,604516,604882,800157,800192,800277,800278,800279,800280,800281,800282,800283,800284,800285,800286,800287,800288,800290,800291,800292,800293,800294,800371,800373,800374,800375,800376,800377,800378,800432,800465,800466,800468,800469,800504,800505,800506,800527,800563,800564,800568,800569,800580,800583,800858,800859,800861,800885,801107,801108,801109,801110,801111,801112,801113,801115,801116,801269,801272,801273,801274,801275,801276,801277,801278,801279,801280,801281,801283,801285,801286,801287,801288,801289,801290,801291,801292,801293,801294,801302,801303,801338,801339,801376,801378,801385,801386,801387,801388,801389,801390,801391,801392,801393,801394,801395,801396,801408,801409,801410,801411,801412,801413,801414,801453,801460,801478,801522,801532,801542,801544,801545,801546,801547,801548,801550,801560,802106,802107,802178,802179,802180,802182,802183,802312,802313,802314,802445,802446,802447,802448,802450,802451,802452,802453,802456,802603,802609,802610,802611,802614,802615,802617,802623,802625,802626,802662,802663,802681,802682,802683,802693,802694,802837,802899,803065,803171,803325,803326,803327,803330,803331,803333,803345,803403,803404,803405,803439,803440,803442,803447,803448,803449,803450,803455,803456,803457,803512,803513,803514,803557,803558,803559,803588,803589,803590,803591,803592,803596,803669,803670,803810,804097,804098,601288,601290,601292,601294,601295,601296,601632,601633,600909,603723,603879,603880,600009,802472,601148,600249,600068,602500,802473,602728,801507,600218,601766,600217,600219,600327,600331,602173,600391,600387,600121,600267,600416,600417,600250,601675,602685,601673,600262,600263,600264,600254,600222,600256,600118,603725,600044,600324,600321,600318,600320,604604,801508,600340,601742,600138,601010,601014,803346,600418,600419,600420,600421,600155,600191,600341,600322,601126,600275,601127,602736,602738,600053,601062,601620,600976,600113,601739,600747,601022,600252,600251,602516,600129,600130,600042,602868,600981,800193,601130,600968,601131,601132,601133,601005,600007,600745,600384,600029,600030,600116,600143,600204,600142,601032,600744,600139,600278,600140,601728,603268,600268,600306,600151,600083,600084,800617,600860,601070,600783,600834,600892,600124,603006,600181,600183,600187,600188,601729,603382,601778,600031,600774,600837,600889,600882,600928,600907,600799,600135,603661,600132,600133,600134,600131,600136,600351,600137,600128,600989,601078,601072,600718,600719,600352,600111,600309,600310,600311,600090,600091,600032,600825,600092,600985,600978,600982,600764,600859,600792,600957,601042,600987,600990,600853,600851,600883,600895,600833,600887,601634,600914,600323,600115,603001,600087,600390,600884,600827,600852,600791,600816,600817,600330,600869,600868,600864,600866,600776,600754,600755,600360,600820,600773,600765,600952,601047,602969,600855,600854,600763,600276,601073,601071,601087,601076,601085,800613,601061,601056,601054,601059,601149,600972,601147,601035,601031,600953,600248,601041,601092,601151,600746,600822,600885,600811,600810,600809,600980,601057,601063,600901,600899,600902,600900,600835,600841,600846,600334,601134,600735,600948,600947,600848,601111,600891,600388,600797,600798,600856,601019,601029,600721,600726,600728,600782,600778,600329,601081,601067,601065,600821,600298,600714,600715,600713,600712,600711,603726,603724,600863,601082,601086,601068,601627,603922,600760,600758,601106,601105,600756,600785,600831,600832,600839,601115,600828,601661,601662,601663,602145,601671,601672,601575,601577,601578,601579,601631,600757,601794,602544,600802,601215,601216,600936,600938,601797,601796,601887,601888,601789,601784,601669,601800,602530,601775,603935,601781,601831,601836,601835,601830,601806,601808,601886,601844,601847,601707,602567,601890,602256,602266,602261,602258,602290,601848,601849,601850,602287,601889,602990,602991,602268,601809,602555,602538,602542,602049,602050,602552,602546,602547,602548,602669,602670,602680,602681,602722,602659,602723,602676,602675,602506,602505,602509,602510,602511,602507,602504,603037,602559,602560,602561,602564,601852,601853,601857,601858,601863,601869,601873,601875,601880,600054,600164,602182,600433,602117,602121,602123,600165,600100,600101,600099,601373,601612,601725,601726,601737,602101,600169,601155,600177,600178,600180,600036,601153,600146,600147,600103,600106,600144,600145,600152,600158,602167,602168,602169,602170,602171,602172,602174,602178,602180,602183,601617,600052,600055,601619,601618,601621,602515,602518,602523,600800,602545,602554,602553,600912,602741,602743,603931,602754,602756,602755,602753,602752,603151,603033,603035,603028,603534,602749,602936,603012,603013,602979,602894,602896,602897,602893,603026,603050,603051,603052,603053,603054,603056,603057,600849,603976,600916,603063,601771,601772,601774,601773,604061,600266,604056,800071,600073,600072,604979,604980,604981,604982,800111,800113,800084,800085,800087,800088,604933,800158,800187,800206,800202,600224,603002,800230,800345,800353,800598,800599,604936,602980,602981,800700,602974,602973,800347,601891,600430,801941,604605,801939,801940,801817,800619,800620,800621,800622,604603,800623,800624,800625,800627,800628,800204,800626,603269,800185,601611,603004,603005,800191,601727,800779,800784,800194,600221,800189,800188,800190,602985,600223,600220,802187,601055,800978,800979,801077,801078,803336,801053,800951,800952,801942,801943,801944,801945,801098,801099,600041,801081,801822,803837,600358,801888,601885,600830,801451,801621,801622,801563,801564,801562,801565,803337,801566,801567,801568,801569,801570,801571,801572,801574,801576,801577,801579,801580,801581,801582,801584,801585,801474,801475,801476,801477,801465,801466,801467,801468,801469,801471,801472,801473,801301,802188,801824,801827,801828,801829,802736,802803,600794,802104,600722,604934,802122,802138,801637,801638,801639,801640,801641,801642,803338,801006,802114,802115,603933,801720,802257,802256,802258,802253,802252,802254,802255,802221,802248,802224,802228,802241,802232,802233,802243,802244,802377,802378,802379,802380,802381,802382,802383,802386,802387,802388,802503,802392,802393,802159,801924,801818,801819,801820,801821,802954,801823,801825,801826,802158,802184,802185,802130,802131,802177,802204,801620,800166,801717,802289,800783,601034,802282,802283,802284,802285,802206,802205,600297,802397,802399,802400,802402,802403,802404,802405,802406,802440,802441,802442,802489,802490,802572,802573,802484,802485,802487,802488,802486,802175,802176,802574,802575,802576,802577,802578,802511,803302,802480,802481,802482,803339,802424,600826,600843,800864,600781,602540,802491,602220,602222,800164,801718,802407,802408,601083,802394,802395,800159,802423,802733,800782,800781,802702,802703,802706,802707,802708,802750,802753,802755,802665,602745,802499,602737,602730,602729,602739,801506,801509,602740,802501,802658,601018,802656,802657,601053,600946,600951,600717,803496,803340,803341,602886,603055,801340,601792,601832,601033,601048,802737,802867,802868,802849,802852,802854,802855,802856,802857,802858,802859,802860,802869,802870,802847,802848,600779,802923,802924,802734,802735,601802,601799,802817,802818,802819,803887,803888,802872,802878,802893,802894,802896,802897,802898,802919,802920,802921,802922,601668,603926,601576,601660,801936,602678,603991,802991,802992,800348,800349,802137,802993,802994,802995,802996,802997,802998,802984,802986,802987,802988,802989,802990,602498,802704,802705,803114,803116,600967,802288,803018,803014,803015,803016,803017,601157,802912,802913,802914,802915,802916,802917,802918,803012,803118,803119,803120,803133,803132,803056,803057,803342,802751,803218,801721,803110,803343,601786,803348,803349,803350,803351,803157,803158,803159,803160,803161,803162,803163,803164,601665,601355,801341,801937,600963,601837,803227,803652,803254,801342,803225,802401,803239,803240,803241,803242,803243,803244,803996,803997,803998,803131,803578,803653,803395,803396,803397,803398,803399,803400,803266,803838,803839,803840,803841,803842,803843,803844,803845,803846,800086,803352,803412,803413,803414,803415,803416,803417,803418,803419,803420,802467,602255,600720,602257,600729,602259,803432,803433,803434,803437,803435,803246,803247,802505,603928,801719,803278,803279,803280,803284,803283,803253,803394,803391,803389,803390,803393,803392,803299,803300,803301,600965,803303,803304,803305,601354,801725,601058,802752,600840,801619,800083,800203,800205,803384,803385,802286,803307,803306,803515,803421,803422,803482,803483,803552,803553,803554,803555,803556,803847,803494,803493,803281,803282,803495,801722,803492,600299,803521,803534,803537,803538,803539,803540,803541,803542,800354,600844,602221,802497,803436,803570,803571,601676,803527,803528,803529,803530,803531,803532,803533,803633,803522,803523,602878,803226,803567,802579,803519,803520,803525,803573,803575,803574,803560,803564,803565,803566,800935,803568,802375,802376,602563,802157,803654,802876,601037,803576,803577,803548,803549,801578,601788,600743,600742,803561,803562,803563,803582,803572,803982,803983,803984,802754,600922,802476,803579,803580,803581,602539,602537,803382,803383,602668,801723,803609,803610,803611,803612,803613,803614,803593,802411,803638,600766,601670,803627,803628,803632,803629,803630,803617,803616,803618,803619,803165,600894,803622,803623,803624,803625,803631,803626,803620,803621,600731,600733,600736,803698,803697,803701,803702,803703,601801,803812,803813,803814,803815,803816,803817,803818,803819,803820,803821,803822,803823,803824,803825,803826,803827,801080,801075,803850,803831,803833,803834,803835,803836,803848,803849,803828,803829,803830,803865,803699,800863,802583,803742,801726,802892,600020,600021,600027,800165,803743,803744,803745,803746,803747,600737,600734,801724,600011,803891,803855,803856,802396,802398,803999,804000,804001,804002,600014,600955,602551,802127,802136,600015,600012,600016,600017,600018,600019,802475,600013,600025,802422,803890,600732,602895,801925,803868,803867,803866,803881,803869,803569,803013,600772,801935,803931,803953,803954,803955,604935,803882,803894,802412,600730,602254,802492,802494,602217,602218,802496,602541,600023,802478,802982,803973,803974,803975,803976,803977,600269,802873,802874,802887,804013,804101,804100,602550,803550,803967,804059,601116,804090,804091,804092,804093,804094,804064,804065,804066,804067,804061,804062,804008,804068,804069,804070,804071,804072,804073,804074,804075,804076,804077,804078,804079,804080,804081,804082,804083,804084,804102,601129,802474,600022,600024,600168,600159,600160,601674,603450,603889,600359,600353,600354,600357,600270,600274,600431,600432,601892,600409,600410,600412,600203,600056,600058,600038,600040,600265,600380,600381,600225,600226,600413,600415,600355,600066,600069
	SELECT ProdID FROM r_ShopifyProds WHERE ProdID NOT IN (0) AND UpdateState NOT IN (-1,6,7,8,9,10)
	)
	) s2 
	where (Д > 0 OR Х > 0 OR К > 0) 

SELECT * FROM @TableProds where PricePromo >= Price

IF OBJECT_ID (N'dbo.at_Hotline_PL', N'U') IS NOT NULL DROP TABLE dbo.at_Hotline_PL
CREATE TABLE dbo.at_Hotline_PL ( ID INT IDENTITY(1,1), XML VARCHAR(MAX))

------------------------------------Начало вормирования хэдера----------------------------------------
INSERT INTO dbo.at_Hotline_PL SELECT ('<?xml version="1.0" encoding="windows-1251" ?>') AS txt -- добавляем хэдер
INSERT INTO dbo.at_Hotline_PL SELECT ('<price><date>' + (CONVERT(VARCHAR(16),GETDATE(),120)) + '</date>') AS txt -- добавляем дату
INSERT INTO dbo.at_Hotline_PL SELECT '<firmName>Винтаж</firmName>' -- добавляем название фирмы
INSERT INTO dbo.at_Hotline_PL SELECT '<firmId>36860</firmId>' -- добавляем код фирмы
INSERT INTO dbo.at_Hotline_PL SELECT '<categories>' -- добавляем открывающий тег для категорий
INSERT INTO dbo.at_Hotline_PL --добавляем категории
	SELECT ('<category><id>' + CONVERT(VARCHAR(20), m.PGrID5) + '</id><name>' + m.PGrName5 +'</name></category>') AS txt 
	FROM (SELECT DISTINCT rpc.PGrID5, rpc.PGrName5 FROM r_Prods rp
			JOIN at_r_ProdG5 rpc WITH(NOLOCK) ON rpc.PGrID5 = rp.PGrID5
			WHERE rp.ProdID in (select ProdID from @TableProds)
			) AS m
	ORDER BY m.PGrName5
INSERT INTO dbo.at_Hotline_PL SELECT '</categories>' -- добавляем закрывающий тег для категорий
----------------------------Конец формирования хэдера-----------------------------------------

----------------------------Начало формирования списка товаров--------------------------------
INSERT INTO dbo.at_Hotline_PL SELECT '<items>' -- добавляем открывающий тег для списка товаров

INSERT INTO dbo.at_Hotline_PL --добавляем товары
	SELECT  ('<item>' +
			+'<id>' + CONVERT(VARCHAR(20), m.ProdID) + '</id>'
			+'<categoryId>' + CONVERT(VARCHAR(20), m.PGrID5) + '</categoryId>'
			+'<categoryName>' + [dbo].[af_ReplaceForXML]( (SELECT top 1 p5.PGrName5 FROM at_r_ProdG5 p5 where p5.PGrID5 = m.PGrID5) ) + '</categoryName>'
			+'<barcode>' + [dbo].[af_ReplaceForXML]( m.BarCode ) + '</barcode>'
			+'<name>' + [dbo].[af_ReplaceForXML]( m.ProdName ) + '</name>'
			+'<priceRUAH>' + isnull(m.PricePromo,m.PriceMC) + '</priceRUAH>'
			+'<oldprice>' + case when m.PricePromo is null then '' else m.PriceMC end + '</oldprice>'
			+'<stock>'+ 'В наличии' + '</stock>'
			+'<vendor>'+ [dbo].[af_ReplaceForXML]( isnull( (SELECT top 1 p6.PGrName6 FROM at_r_ProdG6 p6 where p6.PGrID6 = m.PGrID6) ,'') ) + '</vendor>'
			+'<guarantee type="manufacture">' + '12' + '</guarantee>'
			+ '<param name="Оригинальность">Оригинал</param>'
			+ '<url>' + uris.ShopifyURI + '</url>'
			+ '<image>' + uris.ShopifyImageURI + '</image>'
			+'</item>') AS txt
	 FROM (
			SELECT rp.ProdID, rp.PGrID5,rp.PGrID6, ISNULL(rpmq.BarCode, 0) BarCode, rp.Country, rp.ProdName
			, CONVERT(VARCHAR(20), CAST(tp.PricePromo AS NUMERIC(21,2)) ) PricePromo
			, CONVERT(VARCHAR(20), CAST(tp.Price AS NUMERIC(21,2)) ) PriceMC
		    FROM r_Prods rp 
			JOIN r_ProdMQ rpmq WITH(NOLOCK) ON rpmq.ProdID = rp.ProdID AND rp.UM = rpmq.UM
			JOIN @TableProds tp ON tp.ProdID = rp.ProdID
		  ) AS m
		  LEFT JOIN
		  (
		  	SELECT prods.pr.value('(id)[1]', 'bigint') AS 'ShopifyID'
				  ,CASE WHEN CAST (pr.query('data(variants/variant/sku)') AS VARCHAR(10)) LIKE '%[^0-9]%' 
						THEN 0
						ELSE CAST( (CAST (pr.query('data(variants/variant/sku)') AS VARCHAR(10)) ) AS INT) END 'ProdID'
				  ,'https://vintagemarket.com.ua/products/' + prods.pr.value('(handle)[1]', 'varchar(250)') AS 'ShopifyURI'
				  ,prods.pr.value('(image/src)[1]', 'varchar(4000)') AS 'ShopifyImageURI'
			FROM @prods p CROSS APPLY p.ProdInfo.nodes('products/product') prods(pr)
		  ) AS uris ON uris.ProdID = m.ProdID
		  WHERE uris.ShopifyImageURI IS NOT NULL
							
INSERT INTO dbo.at_Hotline_PL SELECT '</items>' -- добавляем закрывающий тег для списка товаров
----------------------------Конец формирования списка товаров--------------------------------
/*
< (заменить на &lt;)
> (заменить на &gt;)
& (замените на &amp;)
' (замените на &apos;)
" (замените на &quot;)
*/

INSERT INTO dbo.at_Hotline_PL SELECT '</price>' -- добавляем закрывающий тег для списка товаров

SELECT xml FROM dbo.at_Hotline_PL ORDER BY ID

global_destroy:
	EXEC sp_OADestroy @objectID

END