-- Добавить товары в акции v3 от 14.01.2019

USE ElitR
--r_DiscSaleD - Справочник акций: Скидка по товарам
--r_Discs - Справочник акций

BEGIN TRAN
BEGIN

DECLARE  @Replace      int = 1 -- ВЫБРАТЬ: 1 - заменить, 0 - добавить. 

		,@Update_68_15 int = 0 -- ВЫБРАТЬ: 1 - обновить, 0 - не обновлять (15% Супермаркет_на_торжественные_события).

		,@Update_68_20 int = 1 -- ВЫБРАТЬ: 1 - обновить, 0 - не обновлять (20% Супермаркет_на_торжественные_события).
		,@Update_47    int = 1 -- ВЫБРАТЬ: 1 - обновить, 0 - не обновлять (Количественная_акция).

		,@Filter47_1   VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 47 and rdsd.SrcPosID = 1)
		,@Filter47_2   VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 47 and rdsd.SrcPosID = 2)
		,@Filter68_151 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15' and rdsd.SrcPosID = 151)
		,@Filter68_201 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 201)
		,@Filter68_152 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15' and rdsd.SrcPosID = 152)
		,@Filter68_202 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 202)
		,@Msg		   VARCHAR(MAX) = ''
		,@CHARINDEX INT
		,@Part1 VARCHAR(4000)
		,@Part2 VARCHAR(4000)

DECLARE @ProdIDTable table(ProdID int NULL) 
INSERT	INTO @ProdIDTable select ProdID FROM r_Prods	where ProdID in (
--добавить эти товары из фильтра
--1+1
600078,600709,600710,600711,600712,600713,600714,600715,600717,600718,600719,600720,600721,600722,600723,600724,600725,600726,600727,600728,600729,600730,600731,600732,600733,600734,600735,600736,600737,600738,600742,600743,600744,600745,600746,600747,600748,600750,600751,600752,600754,600755,600756,600757,600758,600759,600760,600761,600762,600763,600764,600765,600766,600767,600768,600769,600770,600771,600772,600773,600774,600775,600776,600777,600778,600779,600780,600781,600782,600783,600785,600786,600787,600788,600789,600790,600791,600792,600793,600794,600795,600796,600797,600798,600799,600800,600802,600803,600804,600805,600806,600807,600808,600809,600810,600811,600812,600813,600814,600815,600816,600817,600818,600819,600820,600821,600822,600825,600826,600827,600828,600829,600830,600831,600832,600833,600834,600835,600836,600837,600839,600840,600841,600842,600843,600844,600845,600846,600847,600848,600849,600850,600851,600852,600853,600854,600855,600856,600857,600858,600859,600860,600861,600862,600863,600864,600865,600866,600867,600868,600869,600871,600872,600873,600874,600875,600876,600877,600878,600879,600880,600881,600882,600883,600884,600885,600886,600887,600888,600889,600890,600891,600892,600893,600894,600895,600896,600897,600898,600899,600900,600901,600902,600903,600904,600905,600906,600907,600908,600909,600910,600911,600912,600913,600914,600915,600916,600917,600918,600919,600920,600921,600922,600923,600924,600925,600926,600927,600928,600929,600930,600931,600932,600933,600934,600935,600936,600937,600938,600939,600940,600943,600944,600945,600946,600947,600948,600949,600950,600951,600952,600953,600954,600955,600956,600957,600958,600959,600960,600962,600963,600964,600965,600966,600967,600968,600969,600970,600971,600972,600973,600975,600976,600978,600979,600980,600981,600982,600983,600984,600985,600986,600987,600988,600989,600990,600991,600992,600993,600994,600996,600997,600998,600999,601000,601001,601002,601003,601004,601005,601006,601007,601008,601010,601011,601012,601013,601014,601015,601016,601017,601018,601019,601020,601021,601022,601023,601024,601025,601026,601027,601028,601029,601030,601031,601032,601033,601034,601035,601036,601037,601039,601040,601041,601042,601043,601044,601045,601047,601048,601049,601050,601052,601053,601054,601055,601056,601057,601058,601059,601060,601061,601062,601063,601064,601065,601066,601067,601068,601070,601071,601072,601073,601075,601076,601077,601078,601079,601080,601081,601082,601083,601084,601085,601086,601087,601089,601090,601091,601092,601093,601094,601105,601106,601107,601108,601109,601110,601111,601112,601113,601114,601115,601116,601117,601118,601147,601148,601149,601150,601151,601154,601157,601215,601216,601354,601355,601626,601630,601631,601634,601656,601657,601658,601659,601660,601661,601662,601663,601664,601665,601666,601667,601668,601669,601670,601676,601697,601698,601699,601700,601701,601702,601703,601704,601705,601706,601775,601776,601777,601778,601779,601780,601781,601782,601783,601784,601785,601786,601787,601788,601789,601791,601792,601793,601794,601795,601796,601797,601798,601799,601800,601801,601802,601803,601804,601805,601806,601807,601808,601809,601810,601811,601812,601813,601814,601815,601816,601817,601830,601831,601832,601833,601834,601835,601836,601837,601838,601839,601840,601841,601842,601843,601844,601845,601846,601847,601848,601849,601850,601851,601852,601853,601854,601855,601856,601857,601858,601859,601860,601861,601862,601863,601864,601865,601866,601867,601868,601869,601870,601871,601872,601873,601874,601875,601876,601877,601878,601879,601880,601881,601882,601883,601884,601885,601886,602039,602040,602041,602042,602043,602159,602160,602217,602218,602220,602221,602222,602254,602255,602256,602257,602258,602259,602260,602261,602262,602263,602264,602265,602266,602267,602268,602283,602286,602287,602288,602289,602290,602291,602292,602500,602513,602524,602525,602530,602531,602536,602537,602538,602539,602540,602542,602543,602544,602545,602546,602547,602548,602549,602550,602551,602552,602553,602554,602557,602558,602559,602560,602561,602562,602563,602564,602565,602566,602567,602568,602569,602570,602571,602572,602573,602574,602575,602576,602610,602657,602658,602659,602660,602661,602662,602663,602664,602665,602666,602667,602668,602669,602670,602671,602672,602673,602674,602675,602676,602678,602679,602680,602681,602684,602686,602716,602717,602718,602719,602720,602721,602722,602723,602748,602749,602750,602751,602752,602753,602754,602755,602756,602757,602758,602759,602760,602761,602762,602763,602766,602767,602768,602769,602770,602771,602772,602773,602774,602775,602776,602777,602778,602779,602780,602781,602782,602783,602791,602829,602835,602836,602837,602838,602839,602877,602878,602886,602887,602888,602889,602890,602891,602892,602894,602895,602896,602897,602942,602969,602970,602971,602972,602973,602974,602975,602976,602977,602978,602979,602980,602981,602982,603021,603022,603023,603026,603028,603029,603030,603031,603032,603033,603034,603035,603036,603037,603050,603051,603052,603053,603054,603055,603056,603057,603059,603060,603061,603062,603063,603067,603089,603103,603349,603394,603408,603409,603456,603457,603485,603893,603895,603896,603897,603898,603899,603900,603901,603903,603904,603905,603908,603911,603913,603915,603916,603917,603918,603920,603921,603923,603924,603926,603928,603929,603931,603932,603933,603935,603964,603974,603975,603976,603977,603978,603979,603991,604056,604058,604062,604143,604604,604929,604930,604931,604932,604933,604934,604935,604936,604979,604980,604981,604982,604983,604984,604985,604986,604987,604988,604989,604990,604991,604992,800059,800071,800083,800084,800085,800086,800087,800088,800109,800110,800111,800112,800113,800114,800115,800157,800158,800159,800160,800161,800162,800163,800164,800165,800166,800202,800203,800204,800205,800206,800230,800231,800264,800265,800342,800343,800344,800345,800346,800347,800348,800349,800353,800354,800425,800553,800594,800595,800596,800597,800598,800599,800609,800610,800699,800700,800779,800780,800781,800782,800783,800784,800863,800864,800935,800978,800979,801006,801075,801076,801077,801078,801079,801080,801081,801098,801099,801340,801341,801342,801382,801562,801563,801564,801565,801618,801619,801620,801621,801622,801647,801648,801717,801718,801719,801720,801721,801722,801723,801724,801725,801726,801816,801924,801925,801935,801936,801937,801938,801946,801947,801948,801949,801950,801951,801952,802104,802122,802123,802124,802125,802126,802127,802128,802129,802130,802131,802132,802133,802134,802135,802136,802137,802138,802139,802157,802158,802159,802174,802205,802206,802207,802208,802209,802210,802211,802212,802213,802214,802215,802216,802217,802218,802219,802220,802286,802287,802288,802289,802296,802297,802298,802299,802300,802301,802302,802303,802304,802305,802306,802307,802375,802376,802377,802378,802379,802380,802381,802382,802383,802384,802385,802386,802387,802388,802389,802390,802391,802392,802393,802396,802397,802398,802399,802400,802401,802402,802403,802404,802405,802406,802408,802409,802410,802411,802412,802418,802419,802420,802421,802422,802423,802424,802440,802441,802442,802443,802463,802464,802465,802466,802467,802468,802469,802470,802471,802484,802485,802486,802487,802488,802489,802490,802491,802492,802493,802494,802495,802496,802497,802503,802504,802505,802511,802572,802573,802577,802578,802579,802581,802582,802583,802584,802585,802586,802587,802646,802650,802651,802652,802656,802657,802697,802698,802699,802700,802701,802702,802703,802704,802705,802706,802707,802708,802709,802710,802711,802712,802713,802718,802719,802720,802721,802722,802723,802724,802725,802726,802727,802750,802751,802752,802753,802754,802755,802756,802757,802758,802759,802760,802811,802812,802813,802814,802815,802816,802817,802818,802819,802820,802821,802822,802823,802841,802872,802873,802874,802875,802876,802877,802878,802879,802880,802881,802882,802883,802884,802885,802886,802887,802888,802889,802890,802891,802892,802893,802894,802895,802896,802897,802898,802912,802913,802914,802915,802916,802917,802918,802925,802926,802927,802928,802982,802983,802984,802985,802986,802987,802988,802989,802990,802991,802992,802993,802994,802995,802996,802997,802998,802999,803000,803001,803003,803012,803013,803014,803015,803016,803017,803018,803092,803093,803094,803095,803111,803112,803113,803114,803115,803116,803117,803131,803132,803161,803162,803163,803164,803165,803166,803167,803218,803225,803226,803227,803228,803229,803230,803231,803232,803233,803234,803235,803236,803237,803239,803240,803241,803242,803243,803244,803253,803254,803260,803262,803275,803276,803277,803278,803279,803280,803281,803282,803283,803284,803287,803293,803294,803295,803296,803297,803298,803299,803300,803301,803303,803304,803305,803382,803383,803384,803385,803386,803412,803413,803414,803415,803416,803417,803418,803419,803420,803421,803422,803423,803424,803425,803426,803427,803428,803429,803430,803431,803482,803483,803484,803485,803486,803487,803488,803489,803490,803493,803494,803495,803516,803517,803518,803519,803520,803521,803522,803523,803524,803525,803526,803527,803528,803529,803530,803531,803532,803533,803534,803535,803536,803537,803538,803539,803540,803541,803542,803560,803561,803562,803563,803564,803565,803566,803567,803569,803570,803571,803572,803573,803574,803575,803576,803577,803579,803580,803581,803582,803594,803609,803610,803611,803612,803613,803614,803615,803620,803621,803622,803623,803624,803625,803626,803627,803628,803629,803630,803631,803632,803634,803635,803636,803637,803638,803639,803640,803641,803642,803643,803644,803645,803646,803647,803648,803649,803650,803651,803687,803688,803689,803690,803691,803692,803693,803694,803695,803696,803697,803698,803699,803739,803740,803741,803742,803743,803744,803745,803746,803747,803748,803749,803750,803751,803752,803771,803772,803773,803774,803852,803853,803854,803855,803856,803857,803858,803859,803860,803861,803862,803863,803864,803865,803883,803885,803886,803889,803890,803895,803896,803866,803867,803868,803869,803870,803925,803926,803927,803928,803929,803930,803931,803932,803933,803934,803935,803936,803937,803938,803941,803942,803943,803944,803945,803947,803948,803949,803950,803951,803952,803953,803954,803955,803969,803970,803971,803978,803979,803980,803981,803973,803974,803975,803976,803977,803985
)
--SELECT ProdID FROM @ProdIDTable

IF @Update_47 = 1	
BEGIN
	SET @Msg = ''
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter47_1) where @Replace <> 1
	UNION 
	SELECT * FROM dbo.zf_FilterToTable(@Filter47_2) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = dbo.af_FilterToFilter(SUBSTRING(@Msg,2,65535))

	--Разделить строку на 2 части
	IF LEN(@MSG) > 4000
	BEGIN
		SELECT @CHARINDEX = 4000 - CHARINDEX(',', REVERSE(SUBSTRING(@MSG,1,4000)))
		SELECT @Part1 = SUBSTRING(@MSG,1,@CHARINDEX)
		SELECT @Part2 = SUBSTRING(@MSG,@CHARINDEX+2,LEN(@MSG))
	END
	ELSE 
	BEGIN
		SET @Part1 = @MSG
		SET @Part2 = '0'
	END
	
	SELECT  @Filter47_1  'было1',len(@Filter47_1) 'длина строки1'
			,@Filter47_2 'было2',len(@Filter47_2) 'длина строки2'
			,dbo.af_FilterToFilter(@Part1) Filter47_1_Количественная_акция,len(dbo.af_FilterToFilter(@Part1)) 'длина строки1'
			,dbo.af_FilterToFilter(@Part2) Filter47_2_Количественная_акция,len(dbo.af_FilterToFilter(@Part2)) 'длина строки2'
END

IF @Update_47 = 1
BEGIN
	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part1))
	FROM r_DiscSaleD rdsd
	JOIN r_Discs rd	  ON rdsd.DiscCode = rd.DiscCode and rdsd.SrcPosID = 1
	WHERE rd.DiscCode = 47

	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part2))
	FROM r_DiscSaleD rdsd
	JOIN r_Discs rd	  ON rdsd.DiscCode = rd.DiscCode and rdsd.SrcPosID = 2
	WHERE rd.DiscCode = 47
END
	
IF @Update_68_15 = 1
BEGIN
	SET @Msg = ''	
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_151) where @Replace <> 1 
	UNION 
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_152) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = dbo.af_FilterToFilter(SUBSTRING(@Msg,2,65535))

	SELECT @Msg Msg, LEN(@MSG) 'длина строки'

	--Разделить строку на 2 части
	IF LEN(@MSG) > 4000
	BEGIN
		SELECT @CHARINDEX = 4000 - CHARINDEX(',', REVERSE(SUBSTRING(@MSG,1,4000)))
		SELECT @Part1 = SUBSTRING(@MSG,1,@CHARINDEX)
		SELECT @Part2 = SUBSTRING(@MSG,@CHARINDEX+2,LEN(@MSG))
	END
	ELSE 
	BEGIN
		SET @Part1 = @MSG
		SET @Part2 = '0'
	END

	SELECT @Filter68_151 'было 1',len(@Filter68_151) 'длина строки 1'
		  ,@Filter68_152 'было 2',len(@Filter68_152) 'длина строки 2'
		  ,dbo.af_FilterToFilter(@Part1) Filter68_151_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Part1)) 'длина строки 2'
		  ,dbo.af_FilterToFilter(@Part2) Filter68_152_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Part2)) 'длина строки 2'
END

IF @Update_68_15 = 1
BEGIN
	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part1))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15'  and rdsd.SrcPosID = 151

	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part2))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15'  and rdsd.SrcPosID = 152
END
	
IF @Update_68_20 = 1
BEGIN
	SET @Msg = ''	
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_201) where @Replace <> 1
	UNION 
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_202) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = dbo.af_FilterToFilter(SUBSTRING(@Msg,2,65535))

	--Разделить строку на 2 части
	IF LEN(@MSG) > 4000
	BEGIN
		SELECT @CHARINDEX = 4000 - CHARINDEX(',', REVERSE(SUBSTRING(@MSG,1,4000)))
		SELECT @Part1 = SUBSTRING(@MSG,1,@CHARINDEX)
		SELECT @Part2 = SUBSTRING(@MSG,@CHARINDEX+2,LEN(@MSG))
	END
	ELSE 
	BEGIN
		SET @Part1 = @MSG
		SET @Part2 = '0'
	END

	SELECT  @Filter68_201  'было1',len(@Filter68_201) 'длина строки1'
			,@Filter68_202 'было2',len(@Filter68_202) 'длина строки2'
			,dbo.af_FilterToFilter(@Part1) Filter68_201_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Part1)) 'длина строки1'
			,dbo.af_FilterToFilter(@Part2) Filter68_202_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Part2)) 'длина строки2'
END

IF @Update_68_20 = 1
BEGIN
	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part1))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 201

	UPDATE rdsd
	SET rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Part2))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 202	
END

SELECT AValue ,(SELECT ProdName FROM r_prods where prodid = AValue) 'ProdName', count(AValue) 'Проверка на дубликаты между товарами: акции 15% и 20%' FROM (
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_201)
	UNION ALL
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_202)
	UNION ALL
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_151)
	UNION ALL
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_152)
) s1 group by AValue
having count(AValue) > 1
END;
ROLLBACK TRAN	

----------------------------------------- !ВАЖНО!-----------------------------------------
----------------------------------------- !ВАЖНО!-----------------------------------------
----------------------------------------- !ВАЖНО!-----------------------------------------
--перегенерировать процедуры: GMS Дисконтная система -> Сгенерировать процедуры (для синхронизации с магазинами)
--Проверить можно через Бизнес -> Список акционных товаров.

--select cast(SELECT top 1 rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' as varchar(max))

