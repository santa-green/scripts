/*
select * from it_Spec where  ChID in 
  (select ChID from it_Spec where  OurID = 12  AND DocID in (
  
178,52,51,334,54,55,344,44,45,47,48,40,123,125,330,340,295,294,332,91,290,289,124,168,170,1299,600000928,600000930,600000940,600000936,600002052,600002055
  order by DocDate
*/

BEGIN TRAN


DECLARE @Mchid int, @chid INT,
@NewStockid int = 1315, --новый склад карточки 
@NewDocDate smalldatetime = '20180427', --нова€ дата карточки
@OurID int = 12, --старый номер фирмы
@NewOurID int = 12 --новый номер фирмы
DECLARE @ChIDTable table(ChID int NULL) 
insert into @ChIDTable select ChID from it_Spec
	where DocID in (
--¬ведите Ќомера документов   	

5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,25,27,28,29,30,32,33,35,36,37,38,39,68,71,72,73,63,64,66,78,79,80,81,82,93,87,103,600002198,109,600000954,600001172,600002309,600002311,600002313,600002314,600002316,600002318,600002320,600002322,600002324,600002326,600002328,600002330,600002332,600002334,600002336,600002338,600002340,600000776,600000806,121,141,142,144,145,147,149,229,230,231,235,237,248,250,253,255,257,258,259,260,262,263,264,265,267,268,1434,1436,600001218,1288,1291,1292,600001647,600001197,600001198,1440,296,297,298,299,600002551,600002552,600002553,600002554,600002555,600002556,600002557,600002558,600002559,600002560,600002561,600002562,600002563,600002564,600002565,600002566,600002567,600002568,600002569,600002570,600002571,600002572,600002573,600002574,600002575,600002576,600002577,600002578,600002579,266,271,160,161,164,174,600001813,94,95,96,67,65,1,4,58,34,60,61,74,75,76,77,83,84,104,108,600002201,600002202,600002204,600002205,600002206,600002207,600002209,600002210,600002212,600002213,600002214,600002215,600002219,600001932,600001934,600001936,600001938,600002492,600002461,600002462,600002465,600002466,600002467,600002468,600002469,600002470,600002471,600002472,600002475,600002476,600002382,600002383,600001175,110,600002378,126,127,128,129,130,131,132,600001039,600002484,600002488,181,186,152,154,234,249,236,272,274,275,261,256,251,600002714,311,312,316,606,600002225,600002491,600000010,600002433,600002477,600000055,600000113,600000137,600000139,600000141,600000143,600000145,600000147,600000162,600000168,600000048,600000049,600000050,600000051,600000052,600000053,600000115,600000117,600000128,600000130,600000132,600002600,600001629,600001643,600001645,600002109,600001991,600002052,600002055,1299,289,290,168,170,123,124,125,91,40,600002152,600002153,600002154,600002155,600002156,600002157,600002158,600002159,600002224,600002543,600002545,600002546,600002549,600002550,600002589,600002590,600002591,600002592,600001868,317,319,600002593,600002481,1467,1468,1469,1471,1472,1473,1474,1475,1476,1477,600002490,600002478,600000948,600001174,600002395

)
	
--SELECT * FROM @ChIDTable

select @Mchid = MAX (chid)+1 from it_Spec
select @Mchid as Mchid, @Mchid + (SELECT COUNT(*) FROM @ChIDTable) EndChid

select * from it_Spec 
where OurID = @OurID and ChID in ( SELECT * FROM @ChIDTable)
	
DECLARE kalc CURSOR 
FOR
	select  chid from it_Spec 
	where OurID = @OurID and ChID in ( SELECT * FROM @ChIDTable)
OPEN kalc
FETCH NEXT FROM kalc INTO @chid 
WHILE @@FETCH_STATUS = 0    		 
BEGIN
	--select 'EXEC ip_SpecCopy   @chid,@NewOurID,@NewDocDate,@NewStockid '
	--select 'EXEC ip_SpecCopy '+  cast(@chid as varchar)+','++cast(@NewOurID as varchar)+','+CONVERT( varchar, @NewDocDate, 104)+','++cast(@NewStockid as varchar)
	IF EXISTS ( SELECT top 1 1 FROM it_Spec WHERE OurID = @NewOurID and StockID = @NewStockid and DocDate = @NewDocDate and ProdID in (SELECT ProdID FROM it_Spec WHERE ChiD = @chid) )
	BEGIN--если есть дубликат карточки
		 SELECT '≈сть дубликат карточки, карта не скопированна',* FROM it_Spec WHERE OurID = @NewOurID and StockID = @NewStockid and DocDate = @NewDocDate and ProdID in (SELECT ProdID FROM it_Spec WHERE ChiD = @chid)
	END
	ELSE
	BEGIN
		EXEC ip_SpecCopy  @chid,@NewOurID,@NewDocDate,@NewStockid
	END
	FETCH NEXT FROM kalc INTO @chid 
  END
CLOSE kalc
DEALLOCATE kalc


select * from it_Spec where ChID >= @Mchid
select * from it_SpecParams where ChID >= @Mchid

update it_SpecParams
set StockID = @NewStockid , ProdDate = @NewDocDate
from it_SpecParams where ChID >= @Mchid

select * from it_SpecParams where ChID >= @Mchid


ROLLBACK TRAN

IF @@TRANCOUNT > 0 COMMIT TRAN ELSE ROLLBACK TRAN