-- Добавить товары в акции v2 от 1.12.2018
BEGIN TRAN

USE ElitR

DECLARE @Replace      int = 1 -- 1 - заменить 0 - добавить 
DECLARE @Update_47    int = 1 -- 1 - обновить 0 - не обновлять --Количественная_акция
DECLARE @Update_68_15 int = 0 -- 1 - обновить 0 - не обновлять --15% Супермаркет_на_торжественные_события
DECLARE @Update_68_20 int = 1 -- 1 - обновить 0 - не обновлять --20% Супермаркет_на_торжественные_события
		,@Filter47 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 47 )
		,@Filter68_151 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15' and rdsd.SrcPosID = 151)
		,@Filter68_201 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 201)
		,@Filter68_152 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15' and rdsd.SrcPosID = 152)
		,@Filter68_202 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' and rdsd.SrcPosID = 202)
		,@Msg VARCHAR(MAX) = ''

--если 1=1 то будет замена, а не добавление товаров
--IF 1=1 select @Filter47 = '',@Filter68_15_2 = '',@Filter68_201 = '',@Filter68_15_4 = '',@Filter68_20_3 = ''

--SELECT @Filter
DECLARE @ProdIDTable table(ProdID int NULL) 
insert into @ProdIDTable select ProdID from r_Prods	where ProdID in (
--добавить эти товары из фильтра
--1+1
600005,600006,600009,600011,600012,600013,600014,600015,600016,600017,600018,600019,600020,600021,600022,600023,600024,600025,600027,600029,600030,600031,600032,600035,600038,600039,600040,600041,600048,600049,600051,600053,600054,600056,600057,600058,600060,600071,600072,600073,600074,600075,600076,600077,600079,600081,600082,600086,600100,600101,600122,600124,600128,600129,600130,600131,600132,600133,600134,600135,600136,600137,600151,600152,600155,600156,600157,600159,600160,600162,600163,600168,600169,600180,600190,600191,600199,600203,600204,600205,600206,600208,600209,600210,600211,600215,600248,600249,600250,600251,600252,600254,600259,600260,600265,600266,600267,600268,600269,600270,600271,600274,600275,600276,600283,600284,600285,600286,600297,600298,600299,600309,600310,600311,600312,600313,600314,600323,600325,600328,600329,600335,600336,600337,600338,600339,600340,600353,600354,600355,600356,600357,600358,600359,600360,600361,600380,600381,600402,600403,600409,600411,600412,600413,600414,600415,600416,600417,600418,600419,600420,600421,600423,600424,600430,600431,600433,601100,601101,601102,601143,601157,601288,601293,601575,601576,601578,601579,601580,601607,601611,601627,601628,601629,601671,601672,601673,601674,601675,601742,601766,601767,601771,601772,601773,601774,601887,601888,601890,601891,601892,601893,602049,602050,602054,602059,602060,602078,602081,602093,602098,602102,602103,602104,602127,602167,602168,602172,602174,602181,602353,602354,602355,602356,602382,602383,602384,602385,602390,602400,602406,602407,602410,602431,602439,602442,602443,602444,602445,602446,602447,602452,602454,602496,602497,602504,602505,602506,602507,602508,602509,602510,602511,602512,602515,602516,602517,602518,602519,602520,602521,602522,602523,602555,602556,602728,602729,602730,602734,602735,602736,602737,602738,602739,602740,602741,602742,602743,602745,602885,602893,602990,602991,603004,603005,603006,603014,603150,603151,603167,603350,603450,603659,603661,603723,603724,603725,603726,603879,603880,603881,603882,603883,603888,603889,603891,603914,603922,603984,604061,604151,604634,604850,604851,800011,800236,800237,800238,800239,800241,800242,800243,800244,800246,800247,800248,800435,800436,800437,800561,800566,800573,800574,800577,800579,800580,800581,800583,800593,800619,800625,800627,800628,800977,801055,801056,801115,801271,801287,801288,801289,801290,801291,801295,801296,801297,801298,801299,801300,801301,801315,801349,801351,801352,801360,801363,801395,801440,801454,801460,801466,801469,801470,801471,801472,801473,801474,801475,801476,801477,801506,801507,801508,801509,801510,801511,801522,801539,801566,801567,801568,801569,801570,801571,801572,801573,801574,801575,801576,801577,801578,801579,801580,801581,801582,801583,801584,801585,801637,801638,801639,801640,801641,801642,801827,801828,801829,801888,802114,802115,802175,802176,802177,802184,802185,802186,802187,802188,802221,802222,802223,802224,802225,802226,802227,802228,802229,802230,802231,802232,802233,802234,802235,802236,802237,802238,802239,802240,802241,802242,802243,802244,802245,802246,802247,802248,802249,802250,802251,802252,802253,802254,802255,802256,802257,802258,802259,802260,802261,802262,802263,802264,802265,802266,802267,802268,802269,802270,802272,802273,802277,802278,802282,802283,802284,802285,802317,802318,802319,802394,802395,802472,802473,802474,802475,802476,802477,802478,802479,802480,802481,802482,802483,802498,802499,802500,802501,802502,802574,802575,802576,802588,802645,802658,802659,802664,802665,802733,802734,802735,802736,802737,802803,802846,802847,802848,802849,802850,802851,802852,802853,802854,802855,802856,802857,802858,802859,802860,802861,802862,802863,802864,802865,802866,802867,802868,802869,802870,802871,802919,802920,802921,802922,802923,802924,600008,600095,600278,600280,600351,600429,601209,601737,601739,602295,602304,602305,602311,602325,602330,602336,602339,603137,603139,603141,603400,603529,603709,603710,603711,603713,603714,604400,604401,604402,604403,604514,604515,604516,604606,604607,604608,604609,604615,604616,604617,604618,800371,800375,800376,800378,800460,800461,800462,800464,800465,801069,802606,802607,802614,600064,600085,600087,600088,600117,600261,600317,600326,600332,600333,600410,602881,603102,604897,800576,800584,600783,600803,600931,600932,600935,600936,600938,600939,600964,600965,601830,601851,601852,601853,601854,601855,601856,601857,601858,601859,601860,601861,601862,601863,601864,601865,601866,601867,601868,601869,601871,601872,601873,601874,601875,601876,601877,601878,601879,601880,601881,603029,603978,603979,801817,801939,801940,802952,802953,802954,802955,602498,803110,803118,803119,803120,600386,800622,800621,600112,604603,801053,600067,800620,801451,800626,800624,604605,800623,803140,803141,600083,801818,801819,801820,801821,801822,801823,801824,801825,801826,600084,603382,801941,801942,801943,801944,801945,802204,600080,803056,803057,803133,803157,803158,803159,803160,803246,803247,801465,801467,801468,803260,803261,803262,803266,602685,803302,803306,803307,600723,600725,600751,600811,600829,600831,600879,600880,601027,601065,601066,601669,601703,601707,601789,601796,601806,601808,601813,602039,602262,602265,602266,602267,602286,602287,602291,602540,602542,602546,602547,602548,602554,602659,602675,602681,602686,602719,602720,602721,602722,603020,603021,603023,603057,604936,800158,800231,800343,800344,800345,800594,800595,800597,800599,800935,801949,801950,802126,802306,802402,802404,802418,802486,802582,602887,803093,800617,800613,600394,600398,603482,600050,600110,600141,600189,600238,601287,601642,602402,602403,602405,603153,603184,603185,603187,603270,603271,603286,603287,603288,603289,603307,603429,603431,603435,603451,603718,603720,603721,603722,603727,603939,600010,600033,600028,600034,600102,600089,600195,600196,600200,600197,600214,600392,600425,601741,602046,602051,602052,602048,602053,602057,602733,602731,602747,602867,602868,603065,603064,603168,603884,604895,600047,600104,600114,600119,600120,600166,600167,600175,600176,600185,600346,600389,601273,602179,602314,602331,602408,800768,600059,600385,600408,600407,600422,602514,602866,603274,604894,604896,800749,600094,600097,600150,600174,600255,600397,602177,602312,602315,603066,603292,603294,603295,603440,603464,603965,603966,800562,800565,800567,800570,801375,600065,600192,600193,600194,600216,600198,600253,600318,600315,601577,602044,602045,602047,602056,602055,602271,602280,602744,602880,602882,602883,603011,603534,603611,603380,603980,801052,801452,601291,601295,602430,602583,602584,603071,603073,800433,800434,801490,801491,801492,801513,600201,602058,600001,600003,600004,600007,600036,600037,600042,600044,600046,600052,600055,600062,600066,600068,600069,600070,600090,600091,600092,600093,600096,600098,600099,600103,600105,600106,600111,600123,600125,600138,600139,600140,600142,600143,600144,600145,600146,600147,600148,600158,600161,600164,600165,600171,600173,600177,600178,600181,600182,600183,600184,600186,600187,600188,600207,600217,600218,600219,600220,600221,600222,600223,600224,600225,600226,600227,600228,600229,600235,600236,600256,600257,600258,600262,600263,600264,600282,600287,600288,600289,600290,600291,600292,600293,600294,600295,600296,600300,600302,600303,600304,600305,600306,600307,600308,600320,600321,600322,600324,600327,600330,600331,600334,600341,600342,600344,600345,600347,600349,600352,600390,600393,600395,600396,600399,600404,600405,600406,600434,601214,601290,601292,601294,601296,601581,601583,601584,601585,601586,601587,601588,601590,601591,601594,601595,601596,601597,601598,601599,601601,601608,601609,601610,601612,601617,601618,601619,601620,601621,601632,601633,601724,601725,601726,601727,601728,601729,601730,601731,601732,601733,601743,602117,602118,602119,602120,602121,602122,602123,602124,602125,602126,602128,602138,602139,602169,602170,602171,602173,602178,602180,602182,602183,602293,602294,602296,602307,602310,602319,602320,602321,602322,602324,602326,602327,602328,602329,602332,602333,602409,602426,602427,602428,602429,602432,602433,602434,602435,602436,602437,602438,602440,602441,602448,602449,602450,602451,602453,602455,602456,602457,602458,602459,602460,602461,602462,602463,602464,602465,602467,602468,602469,602470,602482,602493,602494,602495,602936,602985,603001,603002,603003,603012,603070,603072,603104,603107,603110,603142,603221,603244,603247,603248,603268,603269,603301,603302,603303,603396,603397,603399,603428,603432,603434,603438,603541,603561,603562,603608,603687,603715,603716,603717,603937,604358,604882,800185,800186,800187,800188,800189,800190,800191,800192,800193,800194,800195,800263,800285,800286,800287,800288,800289,800290,800291,800292,800293,800294,800370,800372,800373,800374,800377,800428,800429,800430,800431,800466,800467,800468,800469,800527,800560,800563,800564,800568,800569,800571,800572,800575,800578,800582,800585,800861,800885,800951,800952,801108,801109,801114,801280,801302,801303,801334,801338,801339,801377,801378,801380,801385,801386,801387,801389,801390,801392,801453,801478,801479,801480,801481,801482,801483,801484,801485,801486,801487,801489,801512,801523,801524,801525,802105,802106,802107,802169,802170,802171,802172,802173,802279,802280,802281,802449,802450,802452,802453,802456,802457,802458,802459,802460,802461,802600,802601,802602,802603,802604,802605,802608,802609,802610,802611,802612,802613,802621,802622,802625,802626,802660,802661,802670,802671,802672,802673,802674,802675,802676,802677,802678,802679,802680,802681,802682,802683,802684,802685,802686,802687,802688,802689,802690,802691,802692,802693,802694,802695,802696,802739,802800,802836,802838,803169,803170,803171,803267,803268,803318,803319,803320,803326,803327,803328,803329,803330,803331,803332,803333,803334,803335,803345,803403,803404,803405,803439,803442,803443,803444,803445,803446,803447,803448,803449,803450,803512,803514,600063,600213,600212,600426,600427,600428,600432,603660,803143,803336,803338,803387,803388,803394,803340,803341,803349,803350,803351,803392,803393,803399,803342,803398,803396,803337,803339,803346,803347,803352,803389,803395,803397,803400,803436,803554,803437,803496,803491,803492,803549,803551,803432,803435,803343,803348,803390,803391,803433,803434,803515,803548,803550,803553,803552,803555,803556,803568,803578,803593,803633,803700,803701,803702,803703,803775,803812,803813,803814,803815,803816,803817,803818,803819,803820,803821,803822,803823,803824,803825,803826,803827,803828,803829,803830,803831,803832,803833,803834,803835,803836,803837,803838,803839,803840,803841,803842,803843,803844,803845,803846,803847,803848,803849,803850
)

--SELECT ProdID FROM @ProdIDTable
if @Update_47 = 1	
BEGIN
	SET @Msg = ''
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter47) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = SUBSTRING(@Msg,2,65535)
	SELECT @Filter47 'было',len(@Filter47),dbo.af_FilterToFilter(@Msg) Filter47_Количественная_акция,len(dbo.af_FilterToFilter(@Msg))
END
--SELECT @Filter47
if @Update_47 = 1
	update rdsd
	set rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Msg))
	FROM r_DiscSaleD rdsd
	JOIN r_Discs rd	  ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 47
	
if @Update_68_15 = 1
BEGIN
	SET @Msg = ''	
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_151) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = SUBSTRING(@Msg,2,65535)
	SELECT @Filter68_151 'было',len(@Filter68_151),dbo.af_FilterToFilter(@Msg) Filter68_15_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Msg))
END

if @Update_68_15 = 1
	update rdsd
	set rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Msg))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15'  and rdsd.SrcPosID = 151
	
if @Update_68_20 = 1
BEGIN
	SET @Msg = ''	
	SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	
	SELECT * FROM dbo.zf_FilterToTable(@Filter68_201) where @Replace <> 1
	UNION 
	SELECT ProdID FROM @ProdIDTable) mmm
	SET @Msg = SUBSTRING(@Msg,2,65535)
	SELECT @Filter68_201 'было',len(@Filter68_201),dbo.af_FilterToFilter(@Msg) Filter68_20_Супермаркет_на_торжественные_события,len(dbo.af_FilterToFilter(@Msg))
END

if @Update_68_20 = 1
	update rdsd
	set rdsd.PProdFilter = (SELECT dbo.af_FilterToFilter(@Msg))
	FROM r_Discs rd	
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode 
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20'  and rdsd.SrcPosID = 201
	
	--SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 47 

ROLLBACK TRAN	

-- не забудь перегенерировать процедуры приложении Акции


--select cast(SELECT top 1 rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20' as varchar(max))