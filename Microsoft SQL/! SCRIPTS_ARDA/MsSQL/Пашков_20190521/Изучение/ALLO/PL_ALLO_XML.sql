--формирование прайслиста для Алло в XML 

--доработать done?
--добавить конец хэдера done
--а без курсора слабо? easy
--в #xml при выводе может сбится порядок строк и нарушится структура xml файла done

-- Добавил конец хэдера. Добавил порядок строк в таблице. Без курсора moa0 12.10.2018 10:58
USE ElitR

SET NOCOUNT ON

DECLARE @PGrID5 INT
	    ,@PGrName5 VARCHAR(50)
	    ,@ProdID INT
	    ,@ProdBarCode VARCHAR(50)
	    ,@ProdName VARCHAR(50)
	    ,@Notes VARCHAR(50)
	    ,@Country VARCHAR(50)
	    ,@PriceMC VARCHAR(50)
	    ,@PriceList INT = 70
	    ,@ID INT = 0
	    
--DECLARE @Prods VARCHAR(MAX)
--SET @Prods =  '600001,602167,600055,603400,600278,601725,601726,600283,600282,602448,802279,802453,803439,600070,600062,600066,600067,600065,600069,600068,802106,802107,802836,803557,803559,600096,801453,600098,600099,602168,600101,602169,600164,600165,602320,602482,802450,802449,601727,801338,801339,600177,600178,600180,802609,600172,600173,603248,600146,600144,600147,600148,600145,802681,802682,802683,800193,803171,600138,600139,603269,603268,803332,601728,600142,800192,600143,803327,603937,604358,602311,602305,600152,801460,600156,801522,602171,803558,600116,800858,800859,601632,602294,801115,602319,600186,600187,801396,601288,602170,600124,600125,603006,600103,801302,600106,802899,602094,803513,801529,803314,604844,803310,800405,800406,803313,803317,803311,800407,803312,803316,604841,800408,604840,803309,604842,803315,604843,802178,802180,802181,802183,802182,800504,800284,800283,800280,802313,800505,802314,800282,800281,800277,800278,800279,802312,802269,802267,602376,602377,602413,602412,602425,801289,801291,801293,801292,801290,602373,602375,602374,803579,803580,803581,602414,602417,602416,800432,602105,602106,602108,602109,602110,602111,602112,602114,602115,602116,801557,801110,801111,801112,801113,802263,802448,802445,802446,802447,801560,801285,801286,601373,602360,801544,801546,801545,602387,602386,602381,801269,801272,801548,604591,602100,602095,602098,602097,602421,801279,801276,802911,602385,602384,602364,801281,801283,601124,601125,601279,601119,601121,601122,601123,603136,800925,800926,800927,601138,603359,801379,601129,802623,601132,601134,803065,601133,802278,802277,803589,803591,803592,801287,801294,803325,802662,802663,803440,801410,801414,600204,600205,600206,600207,801478,802626,803345,801380,603070,603072,603071,803318,803319,601597,601596,603302,603303,603428,803257,801440,603432,800428,600235,603434,803256,600236,603438,602178,602174,800885,602172,602321,602173,602322,602426,602427,602429,602428,602432,602433,800187,600217,600218,803331,603001,600219,600223,800189,600220,600221,800188,600224,800190,600222,602985,603003,603002,600254,801303,600256,802625,600264,600262,600263,803578,600259,600260,801394,600300,603110,600302,600287,600288,600290,600291,600294,600293,603139,603142,801479,801480,601586,601587,600303,601588,601590,600304,601601,601214,600345,600349,602451,602452,602455,602460,602458,602465,800285,800288,800293,800292,800294,800290,800291,800468,600351,604515,604516,602119,602124,602120,602121,602125,603561,600306,600307,600308,601581,601610,601607,601608,601584,601609,601583,601585,602435,800527,600336,802611,600339,600338,600340,600341,602443,602445,602446,802610,602117,600006,602180,600007,602325,803403,803404,800951,800952,803326,602332,600052,600051,601739,600008,600041,600042,803442,802456,602442,602409,600046,600048,600049,802694,603301,801487,801485,801486,803330,802624,802451,600384,600390,801108,600391,802452,600387,600388,602145,801378,801376,600396,800371,800373,601621,600395,604882,602330,600393,800375,800378,800376,601611,603004,601612,600404,802693,600405,600406,600433,600434,602182,601155,602144,601152,601153,802614,802615,802617,802817,802818,802819,801565,801562,801564,801563,803014,803013,803015,803016,801720,801722,801721,803253,801723,802286,801724,604980,604979,604982,604981,600909,600912,603928,802505,803421,803422,803577,803576,600948,600947,601847,803165,601043,800083,801936,800085,800084,601778,602530,603935,601775,802698,601029,800265,601031,601032,802750,802751,802752,803218,802753,802755,803278,600987,600985,600990,802705,802704,802703,802702,801937,803279,803280,802412,802656,802411,802657,600887,600884,600882,603931,600889,803579,803580,600891,803581,600894,604056,802130,802131,800779,601116,802104,601115,802986,802987,802424,800780,800782,800781,803582,802440,802441,802442,803570,803571,803572,600773,600764,600765,600774,800353,600792,802583,802467,801619,801620,600840,600839,803523,600892,600848,600849,600853,802127,802136,802137,802138,803382,803384,803383,802579,600763,602539,602538,802122,600810,600811,600809,802990,600816,600817,803114,803116,600895,601670,802984,601668,600883,601665,600885,802423,802422,600863,600864,600869,600859,600860,600831,600832,600833,600825,600826,600830,803522,803225,600827,602544,600802,601354,803254,601355,801340,801341,603050,603051,603052,603053,603054,801099,801098,803495,600745,600744,600743,600742,802982,803561,803562,803563,802982,602669,602670,602668,601106,601105,802399,603976,603936,600755,600754,802407,600758,600760,803494,802401,802400,802408,802811,802993,802994,803162,803164,803163,803633,803161,800165,800164,800166,601794,801717,801719,803521,803018,803017,802484,802485,802487,802488,802486,803239,803240,803241,803534,803242,803243,803244,803573,803575,802490,802489,802497,802572,602220,802491,602222,602221,802492,802494,602217,602218,803412,803413,803414,803415,803416,803417,803418,803419,803420,600714,600715,602254,600713,600712,600711,803566,803564,803565,600722,600721,803560,600719,602255,602256,600720,600728,602261,601086,601082,803131,601068,601078,601072,601081,601071,601076,601092,601077,601087,601083,601070,601073,601055,601061,601063,601059,601057,601056,601058,601054,601062,802375,802376,600902,600899,600901,802386,802387,802503,802706,802707,803283,803284,803281,803282,802289,802288,600736,600737,600732,600734,602895,600731,600733,600735,602894,602896,602897,801924,801925,801935,802912,802913,802916,802917,802918,802915,802914,802574,802575,802576,802577,802578,802511,602500,803306,803492,803491,602498,803568,802175,601629,600270,600274,601579,600276,601575,600275,601891,601892,601893,600249,601671,602685,601673,600250,600248,600053,601672,803157,803158,803159,803160,600276,600275,601579,601578,802924,802923,802658,601576,601575,803110,803159,803158,803157,803160,600134,600135,600133,600136,600168,600132,802186,600160,600131,801566,801574,603661,802849,802184,600137,802185,802850,600190,603660,602507,600159,603450,602893,802864,600129,801584,801585,602518,604061,602280,801567,802253,802861,801573,801578,802847,802255,601767,802860,802859,801568,600130,600128,802868,803397,803390,803434,802252,803395,803435,803436,803389,803394,802857,803432,802870,802257,803391,803396,801582,802858,802867,803550,803392,802256,803433,802852,802248,802282,802848,802855,801575,802241,802228,802262,802224,803437,802869,802222,802233,802854,802244,802221,801569,801581,802856,801572,802851,802243,803393,802232,801639,601772,801301,801637,601773,802394,801638,601774,801642,601771,801640,802737,801641,801360,802187,802188,802395,803399,803398,803400,601675,600250,601673,600249,601671,602685,600248,600251,600252,602505,600265,600266,600268,600267,803266,802921,602519,803548,803352,803515,602520,601627,601628,601629,602885,802176,603922,600270,600269,600274,802175,600381,600380,600299,802588,801473,601891,803133,600310,600297,600298,600309,600313,801477,602739,600354,601890,801471,600358,801472,600357,603725,602735,602738,600353,600311,600355,601893,600314,603724,602736,600312,802501,603889,603879,801888,602730,801470,603723,801509,602737,802499,602740,602741,602742,801476,801508,803618,803617,602743,803619,801475,603880,601892,801506,603726,803616,600359,802502,801511,600024,600035,600031,802317,802318,802476,600018,600029,600025,601887,601888,600016,602504,600023,600017,600020,802114,600012,802473,802319,802479,600011,600030,600032,600009,600053,600027,602990,602506,600013,600014,601742,600021,602991,803302,600015,802482,802478,600019,600022,601672,802480,803491,802115,802922,803346,802474,802477,803492,802481,802177,802472,802475,602498,803306,802919,802483,803568,803348,803349,803350,803351,602510,602511,803118,803120,803119,602509,803355,803357,803340,803356,802574,802575,802576,600419,600414,802803,600413,803246,600420,600409,802664,803247,802665,600410,600421,802735,600415,803307,600412,802736,600411,802733,600416,803496,600417,600418,801454,802734,802776,601245,601247,802781,601248,601246,601250,601258,803136,603487,603491,601255,601259,601251,802780,601261,603492,801727,802763,802766,803139,802771,802778,601254,601256,601257,603486,601249,802762,601253,802774,802767,603885,601252,603886,802416,802761,802415,803138,802417,802779,802773,802413,802764'

DECLARE @TableProds table(ProdID int NULL, PriceAllo numeric(21,9) NULL) 
INSERT INTO @TableProds 
	--список товаров для продажи в Алло
	SELECT ProdID,Цена FROM (
	SELECT ProdID,UAProdName
	,max(case when TypeStock = 'Днепр' then Qty else 0 end) 'Д'
	,max(case when TypeStock = 'Киев' then Qty else 0 end) 'К'
	,max(case when TypeStock = 'Харьков' then Qty else 0 end) 'Х'
	,max(PriceCC) Цена
	 FROM (
		SELECT m.ProdID,m.Qty,'Днепр' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsW_Dnepr] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 1
		UNION ALL
		SELECT m.ProdID,m.Qty,'Днепр' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Dnepr] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 1
			UNION ALL
		SELECT m.ProdID,m.Qty,'Харьков' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsW_Harkov] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 5
		UNION ALL
		SELECT m.ProdID,m.Qty,'Харьков' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Harkov] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 5
			UNION ALL
		SELECT m.ProdID,m.Qty,'Киев' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsW_Kiev] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 2
		UNION ALL
		SELECT m.ProdID,m.Qty,'Киев' TypeStock,ep.PriceCC ,rp.UAProdName FROM [av_VC_ExportRemsR_Kiev] m
		JOIN r_Prods rp ON rp.ProdID = m.ProdID
		JOIN [av_VC_ExportPrices] ep ON ep.ProdID = m.ProdID AND ep.RegionID = 2
	) s1
	group by ProdID,UAProdName
	Having ProdID in 
	(
	802923,802924,601576,600276,802658,803110,600275,601578,601575,601579,600055,602167,603400,600278,803157,803158,803160,803159,601725,601726,600283,600282,602448,802279,802453,803439,600070,600062,600066,600067,600065,600069,600068,802106,802107,802836,803557,803243,803244,803239,803241,803534,803240,803242,800165,800164,800166,600737,600736,602895,602897,600731,602896,600734,602894,801935,600732,600733,600735,600763,602538,602539,802899,602094,803254,601355,801341,801340,601354,803513,600764,600765,600773,600774,800353,801717,801719,803521,802288,802289,600816,600817,603052,603051,603050,603054,603053,803278,602670,602668,602669,802994,802993,600742,600743,600744,600745,802505,600909,603928,600912,801529,600947,600948,603976,802488,802484,802487,802485,802486,803279,803280,601029,800265,601031,601032,803314,604844,803310,800405,800406,803313,803317,803311,800407,803312,803316,604841,604840,803309,604842,803315,604843,601847,601043,802178,802180,802181,802183,802182,800504,800284,800283,800280,802313,800505,802314,800282,800281,800277,800278,800279,802312,802408,802811,801098,801099,802399,600758,600760,603936,600754,600755,802407,802401,803494,802400,803495,802269,802267,602376,602377,602413,602412,600990,600985,600987,602425,802492,802494,602217,602218,602221,602222,802491,602220,802440,802441,802442,802411,802656,802657,802412,803114,803116,602530,601778,603935,601775,803218,802753,802752,802751,802750,802755,802579,803165,801289,801291,801293,801292,801290,602373,602375,602374,801924,801925,803014,803013,803016,803015,803577,802422,600883,600882,600885,600884,802423,603931,600887,803579,600889,803580,803581,600891,600892,600894,600895,604056,803420,803418,803419,803416,803417,803415,803414,803413,803412,602414,602417,602416,800432,803382,803384,803383,602105,602106,602109,602110,602111,602112,602114,602116,802583,802467,600792,801557,803253,802286,801720,801724,801721,801722,801723,802990,801110,801111,801112,801113,802122,802915,802916,802912,802913,802914,802918,802917,601055,601062,601057,601056,601058,601063,601059,601054,601061,602544,600802,803281,803282,803283,803284,801562,801565,801563,801564,803562,803561,803563,602261,600728,601070,601068,803131,601071,601073,601072,601076,601077,601078,601081,601082,601083,601086,601087,601092,600901,600899,600902,802137,802136,802138,802263,802982,601794,802448,802445,802446,802447,600809,600810,600811,801937,803421,803422,801560,803162,803164,803633,803161,803163,801285,801286,802698,601373,803575,803573,600825,803522,600826,803225,600827,600830,600831,600832,600833,602360,600839,600840,803523,801544,801546,801545,602387,602386,602381,802376,802375,604981,604982,801269,801272,801548,604591,600848,600849,600853,802707,802706,600859,600860,601665,600863,600864,601668,600869,601670,602100,602095,602098,602097,802497,802984,802503,802387,802386,802572,802490,802489,802127,801620,801619,602421,602255,600719,803560,600720,602256,600721,600722,604980,604979,803565,803564,803566,600711,600712,600713,600714,600715,602254,800085,801936,800084,800083,802577,602500,802511,802578,803576,802703,802704,802702,802705,801279,801276,802911,602385,602384,602364,803018,801281,801283,601124,601125,601279,601119,601121,601122,601123,603136,800925,800926,800927,601106,601105,803582,803571,803572,803570,802104,601115,601116,800779,802424,601138,603359,802986,802987,800780,800781,800782,802130,802131,801379,601129,802623,601132,601134,803065,601133,802278,802277,803589,803591,803592,801287,801294,803325,802662,802663,803440,801410,801414,803017,600168,802282,803559,602518,600096,801453,600098,600099,602168,600101,602169,600164,600165,602320,803433,803432,803434,803437,803435,803436,802184,802185,602482,802450,802449,601727,801338,801339,600177,600178,600180,802609,600172,600173,603248,600146,600144,600147,600148,600145,802681,802682,802683,800193,803171,600138,600139,603269,603268,803332,601728,600142,800192,600143,803327,603937,604358,602311,602305,600152,801460,600156,801522,801567,801566,802221,802222,802224,802228,802867,802232,802233,802868,802861,802241,802243,802864,802244,802248,802854,802858,802860,802856,801568,803389,803390,802850,801578,801573,801574,803391,802855,803392,801581,802849,803393,802857,803394,801569,802859,802852,801582,801572,801575,802851,802252,802253,801585,801584,802255,802256,802257,802869,802870,802262,802848,802847,602171,803558,600116,800858,800859,601632,803395,803396,803397,602294,801115,602319,600186,600187,602893,600159,600160,801396,601288,602507,603450,600190,602280,803550,802186,601767,602170,600124,600125,603006,600128,600129,603660,603661,600130,600131,600132,600133,600134,600135,600136,600137,604061,600103,801302,600106,600204,600205,600206,600207,802395,802394,801478,802626,803345,801380,603070,603072,603071,803318,803319,601597,601596,603302,603303,803398,803399,803400,603428,803257,801440,603432,800428,600235,603434,803256,600236,603438,602178,602174,800885,801641,801640,801642,602172,602321,801301,802187,802188,801360,601771,601772,601773,601774,602173,602322,602426,602427,602429,602428,602432,602433,802737,800187,600217,600218,803331,603001,600219,600223,800189,600220,600221,800188,600224,800190,600222,602985,603003,603002,801637,801638,801639,601675,600248,601671,602685,600250,600252,600251,601673,600249,600254,801303,600256,802625,600264,600262,600263,803578,602505,600259,600260,801394,602519,803548,602520,802921,803515,803266,803352,600266,600265,600267,600268,601627,601628,602885,601629,802176,600270,802175,600269,603922,600274,600381,600380,600297,600298,600299,600300,600302,600287,600288,600290,600291,600294,600293,801470,801471,801472,801473,803133,603139,603142,801479,801480,601586,601587,600303,601588,601590,600304,601601,803616,803617,803618,803619,601214,600345,600349,602451,602452,602455,602460,602458,602465,800285,800288,800293,800292,800294,800290,800291,801475,801476,801477,800468,600351,604515,604516,602119,602124,602120,602121,602125,603561,600306,600307,600308,601581,601610,601607,601608,601584,601609,601583,601585,602435,602443,800527,600336,802611,602445,600338,600340,602446,802610,600339,600341,601890,601891,601893,601892,802499,802588,602737,602730,602736,602741,602738,602739,801506,801508,801509,602740,602735,602742,801511,602743,802501,802502,600312,600309,600313,600310,600314,600311,603723,600353,600354,600355,603724,600358,600357,801888,603879,603725,603880,600359,603726,603889,602117,602504,600006,602180,600007,602325,600024,600012,600011,602991,600013,802472,802475,600020,802479,600032,802922,600035,802477,600009,600014,600015,600016,600018,600017,600019,802474,601742,802483,802482,802919,802478,600021,802481,802476,600025,600031,600029,802473,803346,600022,600023,600027,600030,602990,802480,803403,803404,800951,800952,803326,602332,600052,600051,601739,600008,600041,600042,602506,803442,802456,600053,601672,802177,802115,802114,602442,602409,803302,803568,803491,803492,803306,802318,602498,802319,802317,601887,601888,600046,600048,600049,802694,803348,803349,803351,803350,603301,801487,801485,801486,803330,802624,802451,600384,600390,801108,600391,802452,600387,602145,801378,801376,803340,600396,800371,800373,602510,602509,602511,601621,600395,604882,602330,600393,800375,800378,800376,803355,803356,803357,803118,803119,803120,802574,802575,802576,803138,802767,601254,603486,601256,802413,601251,603487,601248,601247,802415,603885,803136,802774,601261,802778,802763,601245,601252,802764,601257,601255,802761,601246,601253,802773,802417,603491,603492,802416,601249,603886,802779,802771,802762,802781,803139,601259,601250,802766,802780,801727,601258,802776,601611,603004,601612,803496,600404,802693,600405,600406,600415,802733,802734,802736,802735,802803,600414,600420,600421,803247,600417,600411,600412,802664,600413,600418,600419,600410,801454,803246,600409,803307,600416,802665,600433,600434,602182,802817,802819,802818,601155,602144,601152,601153,802614,802615,802617
	)
	) s2 
	--where (Д > 2 and  К > 2 and Х > 2) 
	where (Д > 0 and  К > 0 and Х > 0) 
	--ORDER BY 2


/*
SELECT rp.ProdID, rp.PGrID5, ISNULL(rpmq.ProdBarCode, 0) ProdBarCode, rp.Country, rp.ProdName, CONVERT(VARCHAR(20), rpmp.PriceMC) --, rp.Notes
FROM r_Prods rp 
JOIN r_ProdMQ rpmq WITH(NOLOCK) ON rpmq.ProdID = rp.ProdID AND rp.UM = rpmq.UM
JOIN r_ProdMP rpmp WITH(NOLOCK) ON rpmp.ProdID = rp.ProdID AND rpmp.PLID = @PriceList
WHERE rp.ProdID in (select AValue from zf_FilterToTable(@Prods))
*/
--IF OBJECT_ID (N'tempdb..#xml', N'U') IS NOT NULL DROP TABLE #xml
--CREATE TABLE #xml
--( ID INT IDENTITY(1,1),
--  XML VARCHAR(250))

--IF OBJECT_ID (N'tempdb..#xml', N'U') IS NOT NULL DROP TABLE #xml
--CREATE TABLE #xml
--( ID INT IDENTITY(1,1),
--XML VARCHAR(MAX))

IF OBJECT_ID (N'dbo.at_Allo_PL', N'U') IS NOT NULL DROP TABLE dbo.at_Allo_PL
CREATE TABLE dbo.at_Allo_PL ( ID INT IDENTITY(1,1), XML VARCHAR(MAX))

------------------------------------Начало вормирования хэдера----------------------------------------
INSERT INTO dbo.at_Allo_PL SELECT ('<?xml version="1.0" encoding="windows-1251" ?>') AS txt -- добавляем хэдер
INSERT INTO dbo.at_Allo_PL SELECT ('<price><date>' + (CONVERT(VARCHAR(16),GETDATE(),120)) + '</date>') AS txt -- добавляем дату
--INSERT INTO dbo.at_Allo_PL SELECT CONVERT(VARCHAR(100),('<firmName>' + (SELECT OurName FROM r_Ours WHERE OurID = 6) + '</firmName>')) -- добавляем название фирмы
INSERT INTO dbo.at_Allo_PL SELECT '<firmName>Винтаж</firmName>' -- добавляем название фирмы
INSERT INTO dbo.at_Allo_PL SELECT '<firmId>0206</firmId>' -- добавляем код фирмы
--INSERT INTO dbo.at_Allo_PL SELECT '<rate>'+CONVERT(VARCHAR(20),(SELECT KursCC FROM r_Currs WHERE CurrID = 840))+'</rate>' -- добавляем курс доллара
INSERT INTO dbo.at_Allo_PL SELECT '<categories>' -- добавляем открывающий тег для категорий
INSERT INTO dbo.at_Allo_PL --добавляем категории
	SELECT ('<category><id>' + CONVERT(VARCHAR(20), m.PGrID5) + '</id><name>' + m.PGrName5 +'</name></category>') AS txt 
	FROM (SELECT DISTINCT rpc.PGrID5, rpc.PGrName5 FROM r_Prods rp
			JOIN at_r_ProdG5 rpc WITH(NOLOCK) ON rpc.PGrID5 = rp.PGrID5
			WHERE rp.ProdID in (select ProdID from @TableProds)
			) AS m
	ORDER BY m.PGrName5
INSERT INTO dbo.at_Allo_PL SELECT '</categories>' -- добавляем закрывающий тег для категорий
----------------------------Конец формирования хэдера-----------------------------------------

----------------------------Начало формирования списка товаров--------------------------------
INSERT INTO dbo.at_Allo_PL SELECT '<items>' -- добавляем открывающий тег для списка товаров

INSERT INTO dbo.at_Allo_PL --добавляем товары
	SELECT  ('<item><id>' + CONVERT(VARCHAR(20), m.ProdID) + '-0206' + '</id>'
			+'<categoryId>' + CONVERT(VARCHAR(20), m.PGrID5) + '</categoryId>'
			+'<barcode>' + m.BarCode + '</barcode>'
			+'<vendor>' + m.Country + '</vendor>'
			+'<name>' + m.ProdName + '</name>'
			+'<url>'+ '?' + '</url>'
			+'<image>' + '?' + '</image>'
			+'<priceRUAH>' + m.PriceMC + '</priceRUAH>'
			+'<stock>'+ 'В наличии' + '</stock>'
			+'<guarantee type="manufacture">' + '12' + '</guarantee>'
			+ '<param name="Оригинальность">Оригинал</param>'
			+'</item>') AS txt
	 FROM (SELECT rp.ProdID, rp.PGrID5, ISNULL(rpmq.BarCode, 0) BarCode, rp.Country, rp.ProdName, CONVERT(VARCHAR(20), CAST(tp.PriceAllo AS NUMERIC(21,2)) ) PriceMC--, rp.Notes
		    FROM r_Prods rp 
			JOIN r_ProdMQ rpmq WITH(NOLOCK) ON rpmq.ProdID = rp.ProdID AND rp.UM = rpmq.UM
			--JOIN r_ProdMP rpmp WITH(NOLOCK) ON rpmp.ProdID = rp.ProdID AND rpmp.PLID = @PriceList
			JOIN @TableProds tp ON tp.ProdID = rp.ProdID 
			--WHERE rp.ProdID in (select ProdID from @TableProds)
			) AS m
							
INSERT INTO dbo.at_Allo_PL SELECT '</items>' -- добавляем закрывающий тег для списка товаров
----------------------------Конец формирования списка товаров--------------------------------

INSERT INTO dbo.at_Allo_PL SELECT '</price>' -- добавляем закрывающий тег для списка товаров


SELECT xml FROM dbo.at_Allo_PL ORDER BY ID

--IF OBJECT_ID (N'dbo.at_Allo_PL', N'U') IS NOT NULL DROP TABLE dbo.at_Allo_PL
--CREATE TABLE dbo.at_Allo_PL ( ID INT IDENTITY(1,1), XML VARCHAR(MAX))
--INSERT dbo.at_Allo_PL (xml)
--	SELECT xml FROM #xml ORDER BY ID

EXEC master..xp_cmdshell  'bcp "select xml FROM ElitR.dbo.at_Allo_PL ORDER BY ID" queryout \\s-sql-d4\OT38ElitServer\Import\test\p.xml -c  -r "\n" -C ACP -T -S s-sql-d4'


--SELECT *,1 p FROM #xml 
--UNION ALL
--SELECT *,2 p FROM #xml 
--ORDER BY 3,1




--SELECT * FROM r_ProdMQ WHERE ProdID = 
--SELECT * FROM r_ProdMP WHERE ProdID = 
/*
EXEC [dbo].[ap_OP_SendXML802]      -- @Testing = 1
[ap_OP_Importt_Inv802]
[ap_OP_SendXML802]
[ap_Export_J1201208_Medoc]

select CONVERT(VARCHAR(20), CAST(1013.400000000 AS NUMERIC(21,2)) )
select ROUND(1013.400000000,2) 



*/


