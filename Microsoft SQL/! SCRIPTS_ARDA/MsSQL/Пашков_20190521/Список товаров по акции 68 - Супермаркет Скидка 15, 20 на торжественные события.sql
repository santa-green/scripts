
--Список товаров по акции 68 Супермаркет "Скидка 15, 20% на торжественные события"
SELECT ProdID, ProdName товары_со_скидкой_15_Супермаркет_на_торжественные_события FROM dbo.zf_FilterToTable(
	(SELECT rdsd.PProdFilter FROM r_Discs rd
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15')) ftt
JOIN r_Prods ON r_Prods.ProdID = ftt.AValue
ORDER BY 1

SELECT ProdID, ProdName товары_со_скидкой_20_Супермаркет_на_торжественные_события FROM dbo.zf_FilterToTable(
	(SELECT rdsd.PProdFilter FROM r_Discs rd
	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode
	WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20')) ftt
JOIN r_Prods ON r_Prods.ProdID = ftt.AValue
ORDER BY 1
/*
DECLARE @s varchar(max) = '802866,802857,802860,802859,802853,802854,802849,802850,802851,802852,802856,802856,802869,802870,802871'

--20%
SELECT AValue скидка_20_на_торжество FROM dbo.zf_FilterToTable('600064,600067,600069,600071-600084,600709-600715,600717-600738,600742-600752,600754-600783,600785-600800,600802-600822,600825-600837,600839-600869,600871-600960,600962-600973,600975,600976,600978-600994,600996-601008,601010-601037,601039-601045,601047-601050,601052-601068,601070-601073,601075-601087,601089-601096,601105-601118,601129,601147-601151,601154,601215,601216,601354,601355,601626,601630,601631,601634,601656-601670,601676,601697-601707,601775-601789,601791-601817,601830-601886,602039-602043,602159,602160,602217,602218,602220-602222,602254-602268,602283,602286-602292,602500,602513,602524,602525,602530,602531,602536-602554,602557-602576,602609,602610,602657-602676,602678-602681,602684,602686,602716-602723,602748-602763,602766-602783,602791,602829,602835-602840,602877,602878,602886-602892,602894-602897,602942,602969-602982,603020-603026,603028-603037,603050-603057,603059-603063,603067,603089,603103,603349,603394,603408,603409,603424,603426,603456,603457,603485,603893,603895-603901,603903-603905,603908,603911,603913,603915-603918,603920,603921,603923,603924,603926,603928,603929,603931-603933,603935,603936,603964,603974-603979,603991,604056,604058,604062,604143,604604,604850,604851,604929-604936,604979-604992,800059,800071,800083-800088,800109-800115,800157-800166,800202-800206,800230,800231,800264,800265,800342-800349,800353,800354,800395-800400,800425,800553,800594-800599,800609,800610,800613-800618,800699,800700,800748,800779-800784,800863,800864,800935,800978,800979,801006,801061,801062,801075-801081,801098,801099,801340-801342,801382,801457,801562-801565,801618-801622,801647,801648,801717-801726,801816,801817,801924,801925,801935-801952,802104,802122-802139,802157-802159,802174,802205-802220,802286-802289,802296-802307,802375-802393,802396-802412,802418-802424,802440-802443,802463-802471,802484-802497,802503-802505,802511,802572,802573,802579-802587,802599,802645,802646,802650-802652,802656,802657,802697-802713,802718-802727,802750-802760')
where AValue in (SELECT AValue FROM dbo.zf_FilterToTable(@s))

--15%
SELECT AValue скидка_15_на_торжество FROM dbo.zf_FilterToTable('600001-600025,600027-600042,600044-600060,600062,600063,600085-600090,600094-600112,600114,600116,600117,600119,600120,600122-600126,600128-600149,600151-600173,600175-600178,600180-600184,600186-600216,600218-600224,600226-600236,600240,600245-600254,600256-600261,600265-600300,600302-600315,600317-600319,600323,600325-600345,600347-600361,600380-600383,600385,600386,600388,600389,600392-600396,600399,600402-600435,600739-600741,601097-601104,601119,601121-601125,601127,601130,601135-601140,601142-601145,601152,601153,601155-601207,601209,601212-601214,601273-601279,601287,601289-601353,601356-601376,601575-601581,601583-601588,601590,601591,601594-601601,601605-601612,601617-601621,601624,601627-601629,601632,601633,601642,601671-601675,601677-601694,601724-601739,601741-601746,601766-601768,601770-601774,601887,601888,601890-601893,601909-601919,601937-601990,601992-602020,602022-602038,602044-602128,602135-602139,602144,602145,602161,602167-602216,602219,602223-602253,602271,602280-602282,602293-602301,602303-602340,602347-602401,602404,602406-602420,602422-602470,602473-602499,602504-602512,602514-602523,602532-602535,602555,602556,602577-602585,602611-602613,602615,602685,602728-602747,602866-602868,602880-602883,602885,602893,602940,602941,602985,602990,602991,603001-603006,603011,603014,603064,603065,603068-603073,603078-603088,603102,603104,603106,603107,603109-603116,603118-603124,603126-603131,603133-603137,603139-603142,603150-603152,603154-603156,603158-603160,603162-603165,603167-603172,603178,603179,603183-603191,603193,603194,603196,603198-603200,603202-603205,603207-603212,603221-603225,603232,603235,603238-603240,603243,603244,603246-603249,603263,603264,603267-603274,603276,603278-603289,603291,603293,603296-603302,603304-603309,603311,603313,603315,603317,603318,603324,603326-603328,603330,603335,603348,603350-603358,603362,603363,603366-603370,603374-603377,603379-603387,603389,603395-603397,603399,603400,603402,603403,603412,603413,603422,603423,603425,603428-603430,603432-603435,603438,603439,603441-603444,603446-603452,603454,603458-603463,603468-603471,603473-603476,603482,603529-603534,603538-603541,603545,603546,603548,603550-603558,603560-603582,603608-603612,603650-603669,603671,603672,603676,603678,603682,603683,603687-603699,603702,603703,603706-603711,603713,603714,603718-603728,603730,603732,603733,603879-603884,603888-603892,603894,603902,603906,603914,603922,603937,603939,603944-603946,603948-603950,603954,603958-603960,603963,603965,603966,603971,603980,603984,604050,604061,604151,604283,604308,604332-604358,604379-604381,604400-604405,604514-604516,604591-604603,604605-604622,604625-604628,604630,604634,604635,604637,604639,604641-604643,604840-604844,604882,604894-604897,800011,800141,800185-800195,800234-800248,800263,800277-800310,800352,800370-800378,800390,800405-800408,800428-800432,800435-800437,800458-800469,800485,800486,800502,800504-800506,800527,800532-800542,800560-800564,800566-800585,800593,800619-800628,800749,800766,800767,800861,800885,800925-800928,800951,800952,800977,801052,801053,801055,801056,801069,801072-801074,801110-801116,801162,801167,801168,801262,801263,801266-801283,801285-801303,801315,801334,801338,801339,801343-801347,801349-801352,801360,801363,801375,801385-801396,801398-801404,801408-801414,801440,801451-801454,801456,801460,801465-801477,801485,801486,801489-801492,801506-801513,801522-801561,801566-801585,801637-801642,801818-801829,801888,802078,802105,802106,802114,802115,802169-802173,802175-802188,802204,802221-802273,802275-802285,802312-802319,802394,802395,802454-802461,802472-802483,802498-802502,802574-802578,802588,802600-802626,802658-802665,802670-802696,802728,802733-802739,802800')
where AValue in (SELECT AValue FROM dbo.zf_FilterToTable(@s))



SELECT rd.DiscCode, rd.DiscName,rdsd.LDiscountExp, rdsd.PProdFilter FROM r_Discs rd
JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode
WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20'


SELECT * FROM r_Discs where DiscCode = 68

SELECT * FROM r_DiscChargeD where DiscCode = 68

SELECT * FROM r_DiscChargeDT where DiscCode = 68

SELECT * FROM r_DiscDC where DiscCode = 68

SELECT * FROM r_DiscMessages where DiscCode = 68

SELECT * FROM r_DiscMessagesT where DiscCode = 68

SELECT * FROM r_DiscSale where DiscCode = 68

SELECT * FROM r_DiscSaleD where DiscCode = 68

SELECT * FROM r_DiscSaleDBonus where DiscCode = 68

SELECT * FROM r_DiscSaleBonus where DiscCode = 68

SELECT * FROM r_DiscSaleDT where DiscCode = 68

SELECT * FROM r_DiscSaleT where DiscCode = 68

SELECT * FROM r_DiscsT where DiscCode = 68

*/



-- Удалить товары из акций
DECLARE @Filter47 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 47 )
		,@Filter68_15 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '15')
		,@Filter68_20 VARCHAR(MAX) = (SELECT rdsd.PProdFilter FROM r_Discs rd	JOIN  r_DiscSaleD rdsd ON rdsd.DiscCode = rd.DiscCode WHERE rd.DiscCode = 68 and SUBSTRING(rdsd.LDiscountExp,1,2) = '20')
		,@Msg VARCHAR(MAX) = ''
--SELECT @Filter
DECLARE @ProdIDTable table(ProdID int NULL) 
insert into @ProdIDTable select ProdID from r_Prods	where ProdID in (
--исключить эти товары из фильтра
802210,802209,802213,802214,802217,802218,802212,802211,802215,802216,802219,802220,600212,600213,600072,600073,600076,600077,604851,604850,600877,602508,603975,601093,601094,603024,802205,802206
)
--SELECT ProdID FROM @ProdIDTable	
SET @Msg = ''	
SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	SELECT * FROM dbo.zf_FilterToTable(@Filter47)
WHERE AValue  not in (SELECT ProdID FROM @ProdIDTable)) mmm
SET @Msg = SUBSTRING(@Msg,2,65535)
SELECT dbo.af_FilterToFilter(@Msg) Filter47_Количественная_акция

SET @Msg = ''	
SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	SELECT * FROM dbo.zf_FilterToTable(@Filter68_15)
WHERE AValue  not in (SELECT ProdID FROM @ProdIDTable)) mmm
SET @Msg = SUBSTRING(@Msg,2,65535)
SELECT dbo.af_FilterToFilter(@Msg) Filter68_15_Супермаркет_на_торжественные_события

SET @Msg = ''	
SELECT @Msg = @Msg + ',' + CAST(AValue AS VARCHAR(10)) FROM (	SELECT * FROM dbo.zf_FilterToTable(@Filter68_20)
WHERE AValue  not in (SELECT ProdID FROM @ProdIDTable)) mmm
SET @Msg = SUBSTRING(@Msg,2,65535)
SELECT dbo.af_FilterToFilter(@Msg) Filter68_20_Супермаркет_на_торжественные_события